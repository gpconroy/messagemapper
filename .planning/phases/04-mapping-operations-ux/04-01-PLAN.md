---
phase: 04-mapping-operations-ux
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/mapper/hooks/useDebounce.ts
  - src/app/mapper/components/SearchInput.tsx
  - src/app/mapper/components/FieldTreeNode.tsx
  - src/app/mapper/components/FieldTreeItem.tsx
autonomous: true

must_haves:
  truths:
    - "User can type in a search box above each field panel and see fields filtered by name"
    - "Search filtering has no perceivable input lag (debounced at 300ms)"
    - "Clearing the search box restores all fields"
    - "Required fields display with a distinct visual indicator differentiating them from optional fields"
    - "Field data types are displayed with color-coded badges on each field"
  artifacts:
    - path: "src/app/mapper/hooks/useDebounce.ts"
      provides: "Debounce hook for search input"
      exports: ["useDebounce"]
    - path: "src/app/mapper/components/SearchInput.tsx"
      provides: "Search input component with ARIA labels"
      exports: ["SearchInput"]
    - path: "src/app/mapper/components/FieldTreeNode.tsx"
      provides: "Updated field tree node with search input and filtering"
      contains: "SearchInput"
    - path: "src/app/mapper/components/FieldTreeItem.tsx"
      provides: "Enhanced visual indicators for type and required status"
      contains: "typeColorMap"
  key_links:
    - from: "src/app/mapper/components/FieldTreeNode.tsx"
      to: "src/app/mapper/components/SearchInput.tsx"
      via: "import and render"
      pattern: "import.*SearchInput"
    - from: "src/app/mapper/components/FieldTreeNode.tsx"
      to: "src/app/mapper/hooks/useDebounce.ts"
      via: "debounced search term filters field list"
      pattern: "useDebounce"
---

<objective>
Add search/filter capability to field panels and enhance visual indicators for field metadata.

Purpose: Users working with large schemas (100+ fields) need to quickly find specific fields by name. Additionally, required/optional status and data types need stronger visual differentiation beyond the basic indicators added in Phase 3.

Output: SearchInput component with debounced filtering, enhanced type badges with color coding, and improved required/optional visual indicators.
</objective>

<execution_context>
@C:/Users/gary_/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/gary_/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Key source files to modify
@src/app/mapper/components/FieldTreeNode.tsx
@src/app/mapper/components/FieldTreeItem.tsx
@src/app/mapper/hooks/useFieldTree.ts
@src/types/parser-types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useDebounce hook, SearchInput component, and integrate search filtering into FieldTreeNode</name>
  <files>
    src/app/mapper/hooks/useDebounce.ts
    src/app/mapper/components/SearchInput.tsx
    src/app/mapper/components/FieldTreeNode.tsx
  </files>
  <action>
1. Create `src/app/mapper/hooks/useDebounce.ts`:
   - Generic hook: `useDebounce<T>(value: T, delay: number): T`
   - Uses useState + useEffect with setTimeout/clearTimeout pattern
   - Default delay should be 300ms when used
   - Add 'use client' directive

2. Create `src/app/mapper/components/SearchInput.tsx`:
   - 'use client' component
   - Props: `value: string`, `onChange: (value: string) => void`, `placeholder?: string`, `side: MappingSide`
   - Render an `<input type="search">` with:
     - `aria-label="Search and filter fields by name"`
     - Tailwind styling: small text, border, rounded, padding, full width
     - Side-appropriate accent color (blue for source, green for target)
     - Clear button (the native search input clear 'x' suffices)
   - Export as named export `SearchInput`

3. Update `src/app/mapper/components/FieldTreeNode.tsx`:
   - Add local state: `const [searchTerm, setSearchTerm] = useState('')`
   - Add debounced value: `const debouncedSearch = useDebounce(searchTerm, 300)`
   - Create a `filterFields` helper function that recursively filters FieldNode[] to only include fields whose name (case-insensitive) contains the search term, or whose descendants match. When a parent matches, show all its children. When a child matches, show its parent chain.
   - Render `<SearchInput>` between the header and the field list
   - Pass `filteredFields` (result of filtering data.fields by debouncedSearch) to the field list rendering instead of raw `data.fields`
   - When debouncedSearch is non-empty, auto-expand all matching parent paths so filtered results are visible (call expandAll on filtered tree, or expand matching paths)
   - When debouncedSearch is cleared (empty string), do NOT reset expansion state (let user keep their current expansion)
   - Keep all existing functionality: expand/collapse all buttons, MappingStatusContext, getMappingStatus

Implementation detail for filterFields:
```typescript
function filterFields(fields: FieldNode[], term: string): FieldNode[] {
  if (!term) return fields
  const lower = term.toLowerCase()

  function matches(field: FieldNode): boolean {
    if (field.name.toLowerCase().includes(lower)) return true
    return field.children.some(matches)
  }

  function filter(nodes: FieldNode[]): FieldNode[] {
    return nodes
      .filter(matches)
      .map(node => ({
        ...node,
        children: node.name.toLowerCase().includes(lower)
          ? node.children  // Parent matches: show all children
          : filter(node.children)  // Only matching children
      }))
  }

  return filter(fields)
}
```
  </action>
  <verify>
    - `npx tsc --noEmit` passes with zero errors
    - `npm run build` succeeds
    - Manually verify: FieldTreeNode renders SearchInput above field list
  </verify>
  <done>
    - useDebounce hook exists and exports generic debounce function
    - SearchInput component renders accessible search input with side-appropriate styling
    - FieldTreeNode filters fields based on debounced search term
    - Parent fields shown when any descendant matches search term
    - Clearing search restores full field list
  </done>
</task>

<task type="auto">
  <name>Task 2: Enhance visual indicators with color-coded type badges and required/optional styling</name>
  <files>
    src/app/mapper/components/FieldTreeItem.tsx
  </files>
  <action>
1. Update `src/app/mapper/components/FieldTreeItem.tsx` to enhance visual indicators:

   **Color-coded type badges:**
   - Define a type-to-color mapping object at module level:
     ```typescript
     const typeColorMap: Record<string, string> = {
       string: 'bg-blue-100 text-blue-700',
       number: 'bg-purple-100 text-purple-700',
       integer: 'bg-purple-100 text-purple-700',
       boolean: 'bg-amber-100 text-amber-700',
       date: 'bg-teal-100 text-teal-700',
       object: 'bg-gray-100 text-gray-600',
       array: 'bg-indigo-100 text-indigo-700',
       null: 'bg-gray-100 text-gray-500',
       any: 'bg-gray-100 text-gray-500',
     }
     ```
   - Replace the existing static gray type badge with dynamic color based on `typeColorMap[field.type]`
   - Fallback to 'bg-gray-100 text-gray-600' for unknown types

   **Enhanced required/optional indicators:**
   - Keep the existing red asterisk `*` for required fields
   - Add a subtle left border indicator: required fields get `border-l-2 border-l-red-300` on the field row div
   - Optional fields get `border-l-2 border-l-transparent` (keeps alignment consistent)
   - Add title attribute to the field row: `title={field.required ? 'Required field' : 'Optional field'}`

   **Search match highlighting (optional enhancement):**
   - Accept an optional `searchTerm?: string` prop
   - If searchTerm is provided and non-empty, highlight the matching portion of `field.name` with a `<mark>` tag styled with `bg-yellow-200 rounded`
   - Pass searchTerm through to recursive children

2. Propagate searchTerm prop from FieldTreeNode to FieldTreeItem:
   - In FieldTreeNode, pass `searchTerm={debouncedSearch}` to each top-level FieldTreeItem
   - FieldTreeItem passes it to recursive children

All changes must preserve existing functionality: expand/collapse, handles, mapping status indicators, memoization.
  </action>
  <verify>
    - `npx tsc --noEmit` passes with zero errors
    - `npm run build` succeeds
    - Type badges use distinct colors per type (string=blue, number=purple, boolean=amber, date=teal)
    - Required fields have red left border and asterisk
  </verify>
  <done>
    - Type badges are color-coded by field type with distinct visual identity
    - Required fields clearly distinguishable from optional via left border and asterisk
    - Search term highlights matching text in field names when search is active
    - All existing functionality preserved (handles, expand/collapse, mapping status)
  </done>
</task>

</tasks>

<verification>
1. Build check: `npm run build` completes without errors
2. Type check: `npx tsc --noEmit` passes
3. Visual: Search input appears in both source and target field panels
4. Functional: Typing in search filters fields, clearing restores all
5. Visual: Type badges show distinct colors per type
6. Visual: Required fields have red left border indicator
</verification>

<success_criteria>
- SearchInput component renders in both source and target panels with appropriate color accents
- Typing a field name filters the visible fields with 300ms debounce
- Parent fields remain visible when child fields match the search
- Clearing search restores the complete field tree
- Each field type (string, number, boolean, date, object, array) has a visually distinct color-coded badge
- Required fields are clearly distinguished from optional fields via red left border and asterisk
- All existing features (expand/collapse, connection handles, mapping status) continue working
</success_criteria>

<output>
After completion, create `.planning/phases/04-mapping-operations-ux/04-01-SUMMARY.md`
</output>
