---
phase: 06-validation-testing
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/mapper/components/PreviewPanel.tsx
  - src/app/mapper/components/SampleDataInput.tsx
  - src/app/mapper/components/PreviewResults.tsx
autonomous: true

must_haves:
  truths:
    - "User can input or paste sample JSON data for testing"
    - "User can trigger a preview and see transformation results"
    - "User sees clear success/failure status with per-rule results"
    - "User sees error messages when transformation rules fail"
  artifacts:
    - path: "src/app/mapper/components/PreviewPanel.tsx"
      provides: "Container panel for sample data testing workflow"
      exports: ["PreviewPanel"]
    - path: "src/app/mapper/components/SampleDataInput.tsx"
      provides: "JSON textarea input for sample data with parse validation"
      exports: ["SampleDataInput"]
    - path: "src/app/mapper/components/PreviewResults.tsx"
      provides: "Display component for transformation preview results"
      exports: ["PreviewResults"]
  key_links:
    - from: "src/app/mapper/components/PreviewPanel.tsx"
      to: "/api/transformations/preview"
      via: "fetch POST to existing preview endpoint"
      pattern: "fetch.*api/transformations/preview"
    - from: "src/app/mapper/components/PreviewPanel.tsx"
      to: "src/app/mapper/store/useMappingStore.ts"
      via: "reads connections and transformations from store"
      pattern: "useMappingStore"
---

<objective>
Build the sample data testing panel (VAL-02) that allows users to input sample JSON data and preview transformation results using the existing preview API from Phase 5.

Purpose: Users need to verify their mapping produces correct output before production use. This plan creates the complete preview workflow as self-contained UI components that can be integrated into the mapper page.

Output: PreviewPanel with sample data input and results display components.
</objective>

<execution_context>
@C:/Users/gary_/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/gary_/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/app/api/transformations/preview/route.ts
@src/transformations/pipeline.ts
@src/app/mapper/store/useMappingStore.ts
@src/types/mapping-types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create sample data input component</name>
  <files>src/app/mapper/components/SampleDataInput.tsx</files>
  <action>
    Create a 'use client' component that provides a JSON textarea for entering sample data.

    SampleDataInput component accepts:
    - value: string (the raw JSON text)
    - onChange: (value: string) => void
    - onParsed: (data: Record<string, unknown>) => void (called when valid JSON is parsed)
    - sourceFields?: FieldNode[] (optional, for showing expected fields hint)

    Features:
    - Textarea with monospace font, ~8 rows tall, full width
    - Real-time JSON parse validation: try JSON.parse on each change (debounced 300ms via existing useDebounce hook from src/app/mapper/hooks/useDebounce.ts)
    - Green border when valid JSON, red border when invalid
    - Error message below textarea showing parse error (e.g., "Invalid JSON: Unexpected token at position 42")
    - When JSON is valid, call onParsed with the parsed object
    - Placeholder text: '{\n  "fieldName": "value",\n  "amount": 100\n}'
    - If sourceFields provided, show a small hint below: "Expected fields: fieldName1, fieldName2, ..." (first 5 field names from flattened source schema)

    Style with Tailwind classes matching existing mapper UI patterns (gray backgrounds, rounded borders, text-sm).
  </action>
  <verify>
    npm run build
    Verify no TypeScript errors. Component exports correctly.
  </verify>
  <done>
    SampleDataInput component renders textarea, validates JSON in real-time, shows parse status, and calls onParsed with valid data.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create preview results display and preview panel container</name>
  <files>
    src/app/mapper/components/PreviewResults.tsx
    src/app/mapper/components/PreviewPanel.tsx
  </files>
  <action>
    **PreviewResults.tsx** - 'use client' component to display transformation results.

    Accepts props:
    - result: { data: { result: Record<string, unknown>, ruleResults: Array<{ruleId: string, type: string, success: boolean, output?: unknown, error?: string}>, errors?: string[] } } | null
    - isLoading: boolean

    Display:
    - Loading state: show "Processing..." with a subtle animation (opacity pulse via Tailwind animate-pulse)
    - Success state (no errors):
      - Green banner: "Transformation successful - {N} rule(s) applied"
      - "Output" section: JSON.stringify(result.data.result, null, 2) in a pre/code block with bg-gray-100, max-h-60 overflow-auto
      - "Rule Results" section: list each ruleResult with green checkmark icon (unicode) for success, showing type and output preview
    - Partial failure (some errors):
      - Yellow banner: "{N} rule(s) succeeded, {M} failed"
      - Show successful and failed rules separately
      - Failed rules show error message in red
    - Complete failure:
      - Red banner: "Transformation failed"
      - List all errors
    - null result: show nothing (component returns null)

    **PreviewPanel.tsx** - 'use client' container component orchestrating the preview workflow.

    Accepts props:
    - connections: from useMappingStore (array of {sourceFieldPath, targetFieldPath, transformation?})
    - sourceFields?: FieldNode[] (for field hints in sample data input)

    State:
    - sampleDataText: string (raw JSON text)
    - parsedData: Record<string, unknown> | null
    - previewResult: API response | null
    - isLoading: boolean
    - error: string | null (for API/network errors)

    Behavior:
    - Renders SampleDataInput at top
    - "Run Preview" button below input - disabled when: no parsedData, no connections with transformations, or isLoading
    - On click:
      1. Build transformation rules array from connections that have transformations:
         For each connection with a transformation, create a rule object:
         { id: connection.id, type: transformation.type, sourceFields: [connection.sourceFieldPath], targetField: connection.targetFieldPath, config: transformation.config, order: index }
      2. POST to /api/transformations/preview with { rules, sampleData: parsedData }
      3. Set previewResult from response
      4. Handle errors: network errors show in error state, API errors (400/500) show error message
    - Renders PreviewResults below button with the result
    - If no connections have transformations, show info message: "Add transformations to your mappings to preview results"

    Layout: Vertical stack with consistent spacing (space-y-4). Panel has a subtle border, bg-white, rounded-lg, p-4 padding, with heading "Test with Sample Data" in font-semibold text-lg.
  </action>
  <verify>
    npm run build
    Verify no TypeScript errors. Both components export correctly.
  </verify>
  <done>
    PreviewPanel provides complete sample data testing workflow: enter JSON, click preview, see transformation results with success/failure states and per-rule detail.
  </done>
</task>

</tasks>

<verification>
```bash
npm run build
```
Build succeeds. PreviewPanel, SampleDataInput, and PreviewResults components created with correct TypeScript types and exports.
</verification>

<success_criteria>
- SampleDataInput validates JSON in real-time with visual feedback
- PreviewPanel builds transformation rules from store connections and calls existing preview API
- PreviewResults displays success, partial failure, and complete failure states
- All components use Tailwind styling consistent with existing mapper UI
- Build succeeds with no TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/06-validation-testing/06-02-SUMMARY.md`
</output>
