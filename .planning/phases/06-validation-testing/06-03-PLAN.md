---
phase: 06-validation-testing
plan: 03
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - src/app/mapper/hooks/useMappingValidation.ts
  - src/app/mapper/components/ValidationPanel.tsx
  - src/app/mapper/components/FieldTreeItem.tsx
  - src/app/mapper/components/MappingCanvas.tsx
  - src/app/mapper/hooks/useMappingState.ts
  - src/app/mapper/components/MappingToolbar.tsx
  - src/app/mapper/page.tsx
autonomous: true

must_haves:
  truths:
    - "User sees validation errors for type mismatches on connected fields"
    - "User sees validation errors for unmapped required target fields"
    - "Validation runs automatically with debouncing when connections change"
    - "Validation errors appear in a collapsible panel with error/warning counts"
    - "Fields with validation errors have visual indicators in the field tree"
    - "Preview panel is accessible from the mapper page"
  artifacts:
    - path: "src/app/mapper/hooks/useMappingValidation.ts"
      provides: "Client-side validation hook running validateMapping with debounce"
      exports: ["useMappingValidation"]
    - path: "src/app/mapper/components/ValidationPanel.tsx"
      provides: "Collapsible panel showing validation errors grouped by type"
      exports: ["ValidationPanel"]
  key_links:
    - from: "src/app/mapper/hooks/useMappingValidation.ts"
      to: "src/validation/validate-mapping.ts"
      via: "imports validateMapping function"
      pattern: "import.*validateMapping.*from.*validation"
    - from: "src/app/mapper/hooks/useMappingValidation.ts"
      to: "src/app/mapper/store/useMappingStore.ts"
      via: "reads connections, sourceSchema, targetSchema from store"
      pattern: "useMappingStore"
    - from: "src/app/mapper/components/ValidationPanel.tsx"
      to: "src/app/mapper/hooks/useMappingValidation.ts"
      via: "consumes validation results for display"
      pattern: "useMappingValidation"
    - from: "src/app/mapper/page.tsx"
      to: "src/app/mapper/components/PreviewPanel.tsx"
      via: "renders PreviewPanel in mapper layout"
      pattern: "PreviewPanel"
---

<objective>
Wire the validation engine into the mapper UI: create the validation hook, error display panel, field-level error indicators, and integrate the preview panel into the mapper page.

Purpose: This plan connects the validation logic from Plan 01 and preview UI from Plan 02 into the live mapper experience, completing both VAL-01 (validation errors) and VAL-02 (sample data testing) requirements.

Output: Validation errors appear in real-time as users create mappings, and users can access the preview panel to test with sample data.
</objective>

<execution_context>
@C:/Users/gary_/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/gary_/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-validation-testing/06-01-SUMMARY.md
@src/validation/index.ts
@src/app/mapper/store/useMappingStore.ts
@src/app/mapper/hooks/useMappingState.ts
@src/app/mapper/hooks/useDebounce.ts
@src/app/mapper/components/MappingCanvas.tsx
@src/app/mapper/components/FieldTreeItem.tsx
@src/app/mapper/components/MappingToolbar.tsx
@src/app/mapper/components/PreviewPanel.tsx
@src/app/mapper/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create validation hook and validation panel</name>
  <files>
    src/app/mapper/hooks/useMappingValidation.ts
    src/app/mapper/components/ValidationPanel.tsx
  </files>
  <action>
    **useMappingValidation.ts** - 'use client' hook for real-time mapping validation.

    Import validateMapping from '@/validation' (the barrel export from Plan 01).
    Import useMappingStore to read sourceSchema, targetSchema, and connections.
    Import useDebounce from existing '../hooks/useDebounce'.

    Hook implementation:
    1. Read sourceSchema, targetSchema, connections from useMappingStore
    2. Create a dependency key from connections length + connection IDs (to detect changes)
    3. Debounce the dependency key by 500ms using useDebounce
    4. In a useEffect triggered by debounced key:
       - If both schemas exist and connections.length > 0: run validateMapping(sourceSchema.fields, targetSchema.fields, connections)
       - If only targetSchema exists with required fields but no connections: run validation (will catch missing required fields)
       - Store result in state
    5. Return: { validationResult, isValidating, errorCount, warningCount, fieldErrors } where fieldErrors is a Map<string, ValidationError[]> keyed by field path for quick lookup

    **ValidationPanel.tsx** - 'use client' collapsible panel showing validation results.

    Props:
    - validationResult: ValidationResult | null (from the hook)
    - isValidating: boolean

    Display:
    - Header bar with summary: shows error count (red badge) and warning count (yellow badge)
    - Click header to expand/collapse the error list (default: expanded if errors exist, collapsed if valid)
    - When valid (no errors): Green bar with checkmark "All validations passed"
    - When validating: Show subtle loading indicator in header
    - Error list grouped by type:
      - "Missing Required Fields" section: list fields with red text
      - "Type Mismatches" section: list source->target mismatches with field paths
    - Each error item shows: field path, error message, severity icon (red circle for error, yellow triangle for warning)
    - Compact design - fits in a side panel or bottom bar without dominating the canvas

    Style: Use Tailwind classes. Red for errors (#ef4444), yellow for warnings (#f59e0b), green for valid (#22c55e). Text-sm throughout. Rounded borders, subtle shadows.
  </action>
  <verify>
    npm run build
    Verify no TypeScript errors. Hook and component export correctly.
  </verify>
  <done>
    useMappingValidation hook runs client-side validation with 500ms debounce when connections change. ValidationPanel displays errors grouped by type with expand/collapse.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate validation and preview into mapper page</name>
  <files>
    src/app/mapper/components/FieldTreeItem.tsx
    src/app/mapper/components/MappingCanvas.tsx
    src/app/mapper/page.tsx
  </files>
  <action>
    **FieldTreeItem.tsx** - Add validation error indicators to field items.

    Add an optional prop: validationErrors?: Map<string, Array<{type: string, message: string, severity: string}>>

    In the component, check if the current field's path exists in validationErrors:
    - If error severity: add a small red dot indicator (w-2 h-2 rounded-full bg-red-500) next to the field name
    - If warning severity: add yellow dot
    - On hover over the dot, show a tooltip with the error message (use a simple CSS-only tooltip with absolute positioning, or title attribute for simplicity)
    - Do NOT change the existing component structure significantly - just add the indicator as an additional element in the existing flex layout

    Pass validationErrors through the component hierarchy. Since FieldTreeItem is rendered inside FieldTreeNode which is a React Flow custom node, the errors need to flow through the MappingStatusContext or a new context.

    **MappingCanvas.tsx** - Extend MappingStatusContext to include validation errors.

    Update the MappingStatusContext to also include:
    - validationErrors: Map<string, Array<{type: string, message: string, severity: string}>>

    Add validationErrors to MappingCanvasProps and pass through context provider.

    **page.tsx (src/app/mapper/page.tsx)** - Wire everything together in the mapper page layout.

    Read the current page.tsx first. Then:
    1. Import useMappingValidation hook
    2. Import ValidationPanel component
    3. Import PreviewPanel component (from Plan 02)
    4. Call useMappingValidation() in the MapperContent component (or wherever useMappingState is called)
    5. Pass validationResult to ValidationPanel
    6. Pass validationErrors map to MappingCanvas props
    7. Add layout for validation and preview:
       - ValidationPanel goes below the canvas area (or in a right sidebar)
       - PreviewPanel goes below ValidationPanel
       - Use a collapsible layout so panels don't overwhelm the canvas
       - Suggested layout: canvas takes most height, validation+preview in a bottom panel area with ~200px height that can be toggled open/closed

    The exact layout integration depends on the current page.tsx structure - read it first and adapt. The key requirement is that both panels are accessible without obscuring the mapping canvas.
  </action>
  <verify>
    npm run build
    npm run dev (start dev server, check localhost:3000/mapper loads without errors)
  </verify>
  <done>
    Mapper page shows validation errors in real-time below the canvas. Fields with errors have visual indicators. PreviewPanel is accessible for sample data testing. Build succeeds.
  </done>
</task>

</tasks>

<verification>
```bash
npm run build
npm test -- --testPathPattern="src/validation" --verbose
```
Build succeeds. All validation tests still pass. Mapper page renders with validation panel and preview panel integrated.
</verification>

<success_criteria>
- Validation runs automatically (debounced) when connections change
- Type mismatch errors appear for incompatible source-target type connections
- Missing required field errors appear when required target fields lack mappings
- Errors display in a collapsible panel with counts
- Fields with errors have visual indicators in the field tree
- PreviewPanel is accessible from the mapper page
- Build succeeds with no TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/06-validation-testing/06-03-SUMMARY.md`
</output>
