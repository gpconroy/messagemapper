---
phase: 03-visual-mapping-interface
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/app/mapper/components/FieldTreeNode.tsx
  - src/app/mapper/components/FieldTreeItem.tsx
  - src/app/mapper/hooks/useFieldTree.ts
  - src/app/mapper/components/MappingCanvas.tsx
autonomous: true

must_haves:
  truths:
    - "User sees source fields on the left panel with hierarchical tree structure"
    - "User sees target fields on the right panel with hierarchical tree structure"
    - "User can expand and collapse nested field structures"
    - "Each leaf field has a visible connection handle for drawing mappings"
  artifacts:
    - path: "src/app/mapper/components/FieldTreeNode.tsx"
      provides: "Custom React Flow node rendering field tree with handles"
      contains: "Handle"
    - path: "src/app/mapper/components/FieldTreeItem.tsx"
      provides: "Recursive tree item with expand/collapse and per-field handle"
      contains: "FieldTreeItem"
    - path: "src/app/mapper/hooks/useFieldTree.ts"
      provides: "Expansion state management separate from React Flow state"
      contains: "useFieldTree"
  key_links:
    - from: "src/app/mapper/components/FieldTreeNode.tsx"
      to: "src/app/mapper/components/FieldTreeItem.tsx"
      via: "renders FieldTreeItem for each root field"
      pattern: "FieldTreeItem"
    - from: "src/app/mapper/components/FieldTreeItem.tsx"
      to: "@xyflow/react"
      via: "Handle component for per-field connection points"
      pattern: "Handle.*position"
    - from: "src/app/mapper/hooks/useFieldTree.ts"
      to: "React state"
      via: "useState separate from React Flow to prevent collapse on re-render"
      pattern: "useState.*Record.*boolean"
    - from: "src/app/mapper/components/MappingCanvas.tsx"
      to: "src/app/mapper/components/FieldTreeNode.tsx"
      via: "registered in nodeTypes"
      pattern: "nodeTypes.*fieldTree.*FieldTreeNode"
---

<objective>
Build the custom FieldTreeNode React Flow component with recursive tree rendering, per-field connection handles, and expand/collapse functionality that preserves state during React Flow interactions.

Purpose: This replaces the placeholder node from Plan 01 with a production field tree that displays hierarchical schema structure. Source nodes show handles on the right (output), target nodes show handles on the left (input). Expansion state is kept separate from React Flow state to prevent the known pitfall of tree collapse during drag/connect operations.
Output: Full field tree visualization for both source and target panels with clickable expand/collapse and visible connection handles on each leaf field.
</objective>

<execution_context>
@C:/Users/gary_/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/gary_/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-visual-mapping-interface/03-RESEARCH.md
@.planning/phases/03-visual-mapping-interface/03-01-SUMMARY.md
@src/types/parser-types.ts
@src/types/mapping-types.ts
@src/app/mapper/hooks/useMappingState.ts
@src/app/mapper/components/MappingCanvas.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useFieldTree hook and FieldTreeItem recursive component</name>
  <files>
    src/app/mapper/hooks/useFieldTree.ts
    src/app/mapper/components/FieldTreeItem.tsx
  </files>
  <action>
1. Create `src/app/mapper/hooks/useFieldTree.ts`:
   - Manages expansion state as `Record<string, boolean>` via `useState`, keyed by field path (e.g., "root.sender" => true means expanded)
   - CRITICAL: This state is intentionally SEPARATE from React Flow node state. React Flow re-renders nodes on every position change / edge change. If expansion state lives in node data, trees collapse unexpectedly (Pitfall 7 from research).
   - Exports: `useFieldTree()` returning `{ expandedPaths, toggleExpand(path: string), expandAll(fields: FieldNode[]), collapseAll(), isExpanded(path: string) }`
   - `toggleExpand`: flips the boolean for given path
   - `expandAll`: recursively collects all paths of fields that have children, sets them all to true
   - `collapseAll`: resets to empty record (all collapsed)
   - `isExpanded`: returns boolean for given path, default false (collapsed by default)
   - The hook should accept a `nodeId: string` parameter to scope expansion state per node (source vs target have independent expansion state)

2. Create `src/app/mapper/components/FieldTreeItem.tsx`:
   - 'use client' component
   - Props: `{ field: FieldNode; depth: number; side: MappingSide; isExpanded: boolean; onToggle: (path: string) => void; mappingStatus?: FieldMappingStatus }`
   - Renders a single field row with:
     a. Indentation based on depth (use `paddingLeft: depth * 16`)
     b. Expand/collapse chevron icon (right-pointing when collapsed, down-pointing when expanded) -- only shown if `field.children.length > 0`. Use simple Unicode characters: "\u25B6" (collapsed) and "\u25BC" (expanded). Clicking toggles via `onToggle(field.path)`.
     c. Field name in medium weight text
     d. Field type badge: small pill/tag showing the type (e.g., "string", "number", "object") with subtle background color. Use Tailwind: `text-xs px-1.5 py-0.5 rounded bg-gray-100 text-gray-600`
     e. Required indicator: small red asterisk "*" after name if `field.required === true`
     f. Connection Handle: For source side (`side === 'source'`), render a `<Handle>` from @xyflow/react with `type="source"` and `position={Position.Right}` on the RIGHT edge of the row. For target side (`side === 'target'`), render `<Handle>` with `type="target"` and `position={Position.Left}` on the LEFT edge.
     g. Handle ID must encode the field path: `id={field.path}` -- this is how connections know which specific field is connected. React Flow allows multiple handles per node when each has a unique id.
     h. Only render handles on leaf fields AND expanded parent fields. If a field has children and is collapsed, show a handle on it (representing the whole subtree). If expanded, don't show handle on the parent -- show handles on children instead.
   - If `isExpanded` is true and field has children, recursively render FieldTreeItem for each child at `depth + 1`
   - Styling: `hover:bg-blue-50` on the row, `cursor-pointer` on the expand toggle, thin bottom border for visual separation
   - Memoize with `React.memo` to prevent unnecessary re-renders when other fields change
  </action>
  <verify>
    - `npx tsc --noEmit` passes with zero errors
    - FieldTreeItem renders recursively for nested structures
    - useFieldTree manages expansion state independently from React Flow
  </verify>
  <done>
    useFieldTree hook manages per-node expansion state separate from React Flow. FieldTreeItem recursively renders field trees with expand/collapse chevrons, type badges, required indicators, and per-field connection handles positioned correctly for source (right) and target (left) sides.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create FieldTreeNode custom node and register in MappingCanvas</name>
  <files>
    src/app/mapper/components/FieldTreeNode.tsx
    src/app/mapper/components/MappingCanvas.tsx
  </files>
  <action>
1. Create `src/app/mapper/components/FieldTreeNode.tsx`:
   - 'use client' component
   - This is the React Flow custom node that wraps the field tree. It receives `NodeProps<MappingNodeData>` from React Flow.
   - Uses `useFieldTree(nodeId)` hook for expansion state (nodeId comes from React Flow node id: 'source-node' or 'target-node')
   - Renders:
     a. A container div with fixed width (`w-72`) and max-height with overflow-y-auto (`max-h-[70vh] overflow-y-auto`) for scrollability
     b. Header bar: shows `data.label` (the filename) in bold, with "Source" or "Target" badge based on `data.side`. Background: light blue for source, light green for target. Include "Expand All" / "Collapse All" small text buttons in the header.
     c. Field list: maps over `data.fields` and renders a `<FieldTreeItem>` for each root field, passing `isExpanded` from useFieldTree and `onToggle` callback
     d. Empty state: if `data.fields.length === 0`, show "No fields loaded" in gray text
   - Wrap in `React.memo` for performance (React Flow re-renders nodes frequently)
   - Set `displayName = 'FieldTreeNode'`
   - IMPORTANT: The node container needs `className="nowheel nopan"` on the scrollable div. These are React Flow CSS classes that prevent scroll/pan events from propagating to the canvas when user scrolls inside the field tree.

2. Update `src/app/mapper/components/MappingCanvas.tsx`:
   - Replace the placeholder FieldTreeNode with the real import from `./FieldTreeNode`
   - Ensure `nodeTypes` is defined OUTSIDE the component (or useMemo) to prevent React Flow warning about nodeTypes changing on every render: `const nodeTypes = { fieldTree: FieldTreeNode };` at module level
   - Add `connectionLineStyle={{ stroke: '#2563eb', strokeWidth: 2 }}` for visible blue connection lines while dragging
   - Add `defaultEdgeOptions={{ type: 'smoothstep', animated: true, style: { stroke: '#2563eb', strokeWidth: 2 } }}` for styled mapping edges
   - Ensure `proOptions={{ hideAttribution: false }}` (keep React Flow attribution -- it's required for free tier)
  </action>
  <verify>
    - `npx tsc --noEmit` passes with zero errors
    - `npm run build` succeeds
    - `npm run dev` -- visit /mapper, upload a JSON schema to source: see expandable field tree on the left with handles on the right side
    - Upload an XSD to target: see expandable field tree on the right with handles on the left side
    - Click chevrons to expand/collapse nested fields -- expansion state persists during other interactions
    - Scrolling inside a long field tree does not pan the React Flow canvas
  </verify>
  <done>
    Custom FieldTreeNode replaces placeholder, rendering full hierarchical field trees with expand/collapse, type badges, required indicators, and per-field connection handles. Source handles on right, target handles on left. Expansion state survives React Flow re-renders. Scrollable field trees don't interfere with canvas pan.
  </done>
</task>

</tasks>

<verification>
1. Source panel shows field tree with expand/collapse chevrons for nested structures
2. Target panel shows field tree with expand/collapse on the opposite side
3. Expanding a parent shows children with increased indentation
4. Collapsing hides children
5. Each field shows name, type badge, and required indicator where applicable
6. Source fields have connection handles on right edge, target fields on left edge
7. Expansion state survives edge creation/deletion and canvas pan/zoom
8. Build passes, no TypeScript errors
</verification>

<success_criteria>
- FieldTreeNode custom node renders hierarchical field structures
- Expand/collapse works without losing state during React Flow interactions
- Per-field connection handles visible and correctly positioned (source=right, target=left)
- Type badges and required indicators displayed on each field
- No performance issues with typical schema sizes (20-50 fields)
- TypeScript strict mode passes
</success_criteria>

<output>
After completion, create `.planning/phases/03-visual-mapping-interface/03-02-SUMMARY.md`
</output>
