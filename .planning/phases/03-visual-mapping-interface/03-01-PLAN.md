---
phase: 03-visual-mapping-interface
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - src/app/mapper/page.tsx
  - src/app/mapper/components/MappingCanvas.tsx
  - src/app/mapper/components/SchemaUploadPanel.tsx
  - src/app/mapper/hooks/useMappingState.ts
  - src/types/mapping-types.ts
autonomous: true

must_haves:
  truths:
    - "User can navigate to /mapper and see a two-panel layout (source left, target right)"
    - "User can upload a schema file to either the source or target panel"
    - "Uploaded schema fields appear as a React Flow node in the correct panel"
  artifacts:
    - path: "src/app/mapper/page.tsx"
      provides: "Mapper route with React Flow canvas"
      contains: "use client"
    - path: "src/app/mapper/components/MappingCanvas.tsx"
      provides: "React Flow wrapper with two-panel node layout"
      contains: "ReactFlow"
    - path: "src/app/mapper/components/SchemaUploadPanel.tsx"
      provides: "File upload component calling /api/parse-schema"
      contains: "parse-schema"
    - path: "src/app/mapper/hooks/useMappingState.ts"
      provides: "Centralized state for nodes, edges, field data"
      contains: "useNodesState"
    - path: "src/types/mapping-types.ts"
      provides: "TypeScript types for mapping UI state"
      contains: "MappingNodeData"
  key_links:
    - from: "src/app/mapper/components/SchemaUploadPanel.tsx"
      to: "/api/parse-schema"
      via: "fetch POST with FormData"
      pattern: "fetch.*api/parse-schema"
    - from: "src/app/mapper/hooks/useMappingState.ts"
      to: "src/types/mapping-types.ts"
      via: "imports mapping types"
      pattern: "import.*mapping-types"
    - from: "src/app/mapper/page.tsx"
      to: "src/app/mapper/components/MappingCanvas.tsx"
      via: "renders MappingCanvas"
      pattern: "MappingCanvas"
---

<objective>
Install React Flow, create the /mapper page with a React Flow canvas, and build schema file upload that loads FieldNode trees into left (source) and right (target) panels.

Purpose: This is the first visual UI work -- establishing the mapper page skeleton, React Flow integration, and the upload-to-display pipeline that all subsequent mapping interaction builds upon.
Output: Working /mapper page where users can upload source and target schema files and see field trees rendered as React Flow nodes.
</objective>

<execution_context>
@C:/Users/gary_/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/gary_/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-visual-mapping-interface/03-RESEARCH.md
@.planning/phases/02-format-parser-registry/02-03-SUMMARY.md
@src/types/parser-types.ts
@src/app/api/parse-schema/route.ts
@src/app/layout.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install React Flow, create mapping types, and build centralized state hook</name>
  <files>
    package.json
    src/types/mapping-types.ts
    src/app/mapper/hooks/useMappingState.ts
  </files>
  <action>
1. Install @xyflow/react: `npm install @xyflow/react`

2. Create `src/types/mapping-types.ts` with these types:
   - `MappingSide`: literal union `'source' | 'target'`
   - `MappingNodeData`: interface with `{ side: MappingSide; label: string; fields: FieldNode[]; expanded: Record<string, boolean> }` -- this is the data payload for React Flow custom nodes. Import FieldNode from `@/types/parser-types`.
   - `MappingEdgeData`: interface with `{ sourceFieldPath: string; targetFieldPath: string }` -- metadata stored on each edge connecting two fields.
   - `FieldMappingStatus`: literal union `'mapped' | 'unmapped' | 'partial'`

3. Create `src/app/mapper/hooks/useMappingState.ts`:
   - 'use client' hook that wraps React Flow state management
   - Uses `useNodesState` and `useEdgesState` from @xyflow/react
   - Exports: `useMappingState()` returning `{ nodes, edges, onNodesChange, onEdgesChange, setSourceSchema(fields: FieldNode[], label: string), setTargetSchema(fields: FieldNode[], label: string), onConnect, onEdgesDelete }`
   - `setSourceSchema`: creates/updates a React Flow node at position {x: 0, y: 0} with id 'source-node', type 'fieldTree', and MappingNodeData with side='source'
   - `setTargetSchema`: creates/updates a React Flow node at position {x: 600, y: 0} with id 'target-node', type 'fieldTree', and MappingNodeData with side='target'
   - `onConnect`: wraps `addEdge` from @xyflow/react, adds connection to edges state
   - `onEdgesDelete`: callback for cleaning up deleted edges
   - Node positions should be fixed (not draggable) -- set `draggable: false` on nodes so panels stay in place
   - Initialize with empty nodes and edges arrays
  </action>
  <verify>
    - `npm ls @xyflow/react` shows installed
    - `npx tsc --noEmit` passes with zero errors
    - Types file exports MappingNodeData, MappingEdgeData, MappingSide, FieldMappingStatus
  </verify>
  <done>
    @xyflow/react installed, mapping types defined, state hook created with schema loading functions -- all compiling without errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create mapper page with React Flow canvas and schema upload panels</name>
  <files>
    src/app/mapper/page.tsx
    src/app/mapper/components/MappingCanvas.tsx
    src/app/mapper/components/SchemaUploadPanel.tsx
  </files>
  <action>
1. Create `src/app/mapper/components/SchemaUploadPanel.tsx`:
   - 'use client' component
   - Props: `{ side: MappingSide; onSchemaLoaded: (fields: FieldNode[], fileName: string) => void }`
   - Renders a file input (accept=".json,.xml,.xsd") with a styled drop zone area
   - On file selection: creates FormData with file, POST to `/api/parse-schema`, parses ParserResult response
   - On success: calls `onSchemaLoaded(result.fieldNodes, file.name)`
   - On error: displays error message in red text below the upload area
   - Shows loading state ("Parsing...") while upload is in progress using useState
   - Shows the loaded filename after successful parse
   - Styling: Tailwind classes -- dashed border, rounded corners, centered text, hover state. The panel should be a compact header area (not filling the whole screen), positioned above the React Flow canvas area for each side

2. Create `src/app/mapper/components/MappingCanvas.tsx`:
   - 'use client' component
   - Props: none (uses useMappingState hook internally)
   - Renders `<ReactFlow>` with nodes, edges, onNodesChange, onEdgesChange, onConnect from the hook
   - Import and apply `@xyflow/react/dist/style.css`
   - Register custom nodeTypes: `{ fieldTree: FieldTreeNode }` -- for now, create a minimal placeholder FieldTreeNode that renders `<div>{data.label}: {data.fields.length} fields</div>` with a source Handle on the right and target Handle on the left. This will be replaced in Plan 02 with the full tree component.
   - Include `<Background />` and `<Controls />` from @xyflow/react
   - Set `fitView` prop on ReactFlow
   - The ReactFlow container must have explicit width and height (use `className="w-full h-full"` with parent providing dimensions)
   - Pass `deleteKeyCode="Backspace"` and `onEdgesDelete` from state hook

3. Create `src/app/mapper/page.tsx`:
   - 'use client' at top
   - Layout: full-screen flex column
   - Top bar: simple header with "MessageMapper" title and a back link to "/"
   - Middle section: two SchemaUploadPanel components side by side (source on left, target on right) in a flex row with gap. Each panel gets the corresponding `setSourceSchema` or `setTargetSchema` callback from useMappingState.
   - Bottom section (flex-1, taking remaining height): MappingCanvas component
   - The page needs to wrap content in `<ReactFlowProvider>` from @xyflow/react because useMappingState uses React Flow hooks that require the provider context. Import ReactFlowProvider and wrap the entire page content.
   - Actually, since useMappingState uses useNodesState/useEdgesState which are React Flow hooks, the provider must be above MappingCanvas. Structure: page.tsx renders ReactFlowProvider > layout div > upload panels + MappingCanvas.
  </action>
  <verify>
    - `npx tsc --noEmit` passes with zero errors
    - `npm run build` succeeds
    - `npm run dev` and visit `http://localhost:3000/mapper` -- page loads without errors
    - Upload a JSON file to source panel -- should show "X fields" in the source node
    - Upload a JSON/XML file to target panel -- should show "X fields" in the target node
    - React Flow canvas shows Background grid and Controls (zoom buttons)
  </verify>
  <done>
    /mapper page renders with two upload panels and a React Flow canvas. Uploading a schema file to either side creates a React Flow node showing the field count. No console errors, no SSR hydration issues.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` succeeds with no TypeScript errors
2. Visiting /mapper shows the two-panel layout with upload areas
3. Uploading a .json file to source panel triggers API call and displays parsed fields as a React Flow node on the left
4. Uploading a .xsd file to target panel displays parsed fields as a React Flow node on the right
5. React Flow canvas has background grid and zoom controls
6. No SSR/hydration errors in console (all React Flow components use 'use client')
</verification>

<success_criteria>
- @xyflow/react installed and integrated with Next.js App Router
- /mapper page accessible with two-panel upload layout
- File upload calls existing /api/parse-schema and displays results
- React Flow canvas renders with placeholder field tree nodes
- TypeScript strict mode passes with zero errors
- Build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/03-visual-mapping-interface/03-01-SUMMARY.md`
</output>
