---
phase: 03-visual-mapping-interface
plan: 03
type: execute
wave: 3
depends_on: ["03-02"]
files_modified:
  - src/app/mapper/hooks/useMappingState.ts
  - src/app/mapper/components/MappingCanvas.tsx
  - src/app/mapper/components/FieldTreeItem.tsx
  - src/app/mapper/components/FieldTreeNode.tsx
  - src/app/mapper/lib/validation.ts
autonomous: false

must_haves:
  truths:
    - "User can draw a connector from a source field to a target field to create a 1:1 mapping"
    - "User can see mapping status on each field showing mapped, unmapped, or partially mapped state"
    - "User can delete individual mapping connections"
    - "Invalid connections (source-to-source, target-to-target, self-connections) are prevented"
  artifacts:
    - path: "src/app/mapper/lib/validation.ts"
      provides: "Connection validation rules"
      contains: "isValidConnection"
    - path: "src/app/mapper/hooks/useMappingState.ts"
      provides: "Updated state with mapping status derivation"
      contains: "getMappingStatus"
    - path: "src/app/mapper/components/FieldTreeItem.tsx"
      provides: "Updated with mapping status visual indicators"
      contains: "mappingStatus"
  key_links:
    - from: "src/app/mapper/lib/validation.ts"
      to: "src/app/mapper/components/MappingCanvas.tsx"
      via: "isValidConnection prop on ReactFlow"
      pattern: "isValidConnection"
    - from: "src/app/mapper/hooks/useMappingState.ts"
      to: "src/app/mapper/components/FieldTreeNode.tsx"
      via: "mapping status derived from edges, passed to tree items"
      pattern: "getMappingStatus|mappedPaths"
    - from: "src/app/mapper/components/MappingCanvas.tsx"
      to: "@xyflow/react"
      via: "onEdgesDelete and onConnect for edge management"
      pattern: "onEdgesDelete|onConnect"
---

<objective>
Enable users to draw connections between source and target fields, see mapping status indicators, delete connections, and validate connection rules -- completing the core visual mapping value loop.

Purpose: This is the final plan that delivers the Phase 3 success criteria. After this, users can upload two schemas and visually map fields between them with full CRUD on connections. This is the "aha moment" of the product -- seeing fields connected with visual lines.
Output: Complete mapping interaction: draw connections, see status indicators, delete mappings, with validation preventing invalid connections.
</objective>

<execution_context>
@C:/Users/gary_/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/gary_/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-visual-mapping-interface/03-RESEARCH.md
@.planning/phases/03-visual-mapping-interface/03-01-SUMMARY.md
@.planning/phases/03-visual-mapping-interface/03-02-SUMMARY.md
@src/types/parser-types.ts
@src/types/mapping-types.ts
@src/app/mapper/hooks/useMappingState.ts
@src/app/mapper/components/MappingCanvas.tsx
@src/app/mapper/components/FieldTreeNode.tsx
@src/app/mapper/components/FieldTreeItem.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add connection validation, mapping status derivation, and edge deletion handling</name>
  <files>
    src/app/mapper/lib/validation.ts
    src/app/mapper/hooks/useMappingState.ts
  </files>
  <action>
1. Create `src/app/mapper/lib/validation.ts`:
   - Export `isValidMappingConnection(connection: Connection, nodes: Node[]): boolean`
   - Validation rules:
     a. Prevent self-connections: `connection.source !== connection.target` (shouldn't happen with two nodes, but safety check)
     b. Prevent source-to-source: connection must go FROM source-node TO target-node. Check `connection.source === 'source-node' && connection.target === 'target-node'`. If reversed (target-node to source-node), reject.
     c. Prevent duplicate mappings: if an edge already exists with the same sourceHandle and targetHandle, reject. (This requires edges access -- pass as parameter or use closure.)
   - Export `createMappingEdgeId(sourceFieldPath: string, targetFieldPath: string): string` -- deterministic edge ID like `mapping-${sourceFieldPath}--${targetFieldPath}` for easy lookup
   - Import types from @xyflow/react (Connection, Node, Edge)

2. Update `src/app/mapper/hooks/useMappingState.ts`:
   - Add `getMappedSourcePaths(): Set<string>` -- derives from current edges, extracts `sourceHandle` values into a Set
   - Add `getMappedTargetPaths(): Set<string>` -- derives from current edges, extracts `targetHandle` values into a Set
   - Add `getMappingStatus(fieldPath: string, side: MappingSide, fields: FieldNode[]): FieldMappingStatus`:
     a. If field is a leaf (no children): return 'mapped' if path is in the mapped set for that side, else 'unmapped'
     b. If field has children: check all descendant leaf paths. If all mapped => 'mapped', if some mapped => 'partial', if none => 'unmapped'
   - Use `useMemo` to derive mapped paths sets from edges array -- recompute only when edges change
   - Update `onConnect` to:
     a. Use `createMappingEdgeId` for deterministic edge IDs
     b. Store `sourceHandle` and `targetHandle` (field paths) in edge data as MappingEdgeData
     c. Set edge style: `{ stroke: '#2563eb', strokeWidth: 2 }` and `type: 'smoothstep'`
   - Expose `mappedSourcePaths` and `mappedTargetPaths` Sets from the hook so FieldTreeNode can derive status per field
  </action>
  <verify>
    - `npx tsc --noEmit` passes with zero errors
    - validation.ts exports isValidMappingConnection and createMappingEdgeId
    - useMappingState returns mappedSourcePaths and mappedTargetPaths Sets
  </verify>
  <done>
    Connection validation prevents invalid mappings (self-connections, wrong-direction, duplicates). Mapping status derivation computes mapped/unmapped/partial from edge state. Edge IDs are deterministic for reliable lookup.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire validation to canvas, add mapping status indicators to field tree items</name>
  <files>
    src/app/mapper/components/MappingCanvas.tsx
    src/app/mapper/components/FieldTreeNode.tsx
    src/app/mapper/components/FieldTreeItem.tsx
  </files>
  <action>
1. Update `src/app/mapper/components/MappingCanvas.tsx`:
   - Import `isValidMappingConnection` from `../lib/validation`
   - Create a memoized `isValidConnection` callback using `useCallback` that wraps `isValidMappingConnection` with current nodes
   - Pass `isValidConnection` prop to `<ReactFlow>` -- this prevents invalid connections at drag time (user sees red indicator when dragging to invalid target)
   - Pass `mappedSourcePaths` and `mappedTargetPaths` from useMappingState to FieldTreeNode via node data or a React context. Preferred approach: since FieldTreeNode reads from node data (MappingNodeData), and we can't easily change node data without causing re-renders, create a simple React context `MappingStatusContext` that provides the Sets. Wrap ReactFlow in this provider. FieldTreeNode reads from context.
   - Alternative simpler approach: Pass the Sets as additional props via the React Flow `nodeTypes` mechanism. Actually, the cleanest approach is to use `useReactFlow().getEdges()` inside FieldTreeNode to derive status on the fly. But this re-renders on every edge change. Best balance: store mappedPaths in a React context above ReactFlow, update it via useMemo on edges change.

2. Update `src/app/mapper/components/FieldTreeNode.tsx`:
   - Read mapped paths from MappingStatusContext (or however wired from step 1)
   - For each field rendered, compute its mapping status using the mapped paths Set and pass as `mappingStatus` prop to FieldTreeItem
   - Leaf field: check if `field.path` is in the mapped set for this side
   - Parent field: check descendants -- if all leaf descendants mapped => 'mapped', some => 'partial', none => 'unmapped'

3. Update `src/app/mapper/components/FieldTreeItem.tsx`:
   - Add visual mapping status indicator on each field row:
     a. 'mapped': small green circle dot (or green left-border) -- `bg-green-500 w-2 h-2 rounded-full` positioned at the start of the row
     b. 'unmapped': small gray circle dot -- `bg-gray-300 w-2 h-2 rounded-full`
     c. 'partial': small yellow/amber circle dot -- `bg-amber-400 w-2 h-2 rounded-full`
   - Update Handle styling based on mapping status:
     a. Mapped handles: green border/background
     b. Unmapped handles: gray border
   - Handle should have visible styling (not transparent) -- add `style={{ background: '#2563eb', width: 8, height: 8 }}` for default, green (#22c55e) when mapped
   - Ensure the row highlights subtly when a connection is being dragged to it (React Flow handles this via the `.connecting` CSS class on handles -- add appropriate CSS)
  </action>
  <verify>
    - `npx tsc --noEmit` passes with zero errors
    - `npm run build` succeeds
    - `npm run dev` -- visit /mapper:
      1. Upload source schema (e.g., a JSON file)
      2. Upload target schema
      3. Drag from a source field handle to a target field handle -- connection line appears
      4. Dragging source-to-source is rejected (no connection created)
      5. Mapped fields show green status dot
      6. Unmapped fields show gray status dot
      7. Select an edge and press Backspace -- edge is deleted, status dots revert to gray
      8. Parent fields with some children mapped show amber/partial status
  </verify>
  <done>
    Users can draw connections between source and target fields. Invalid connections rejected at drag time. Each field shows mapping status (green=mapped, gray=unmapped, amber=partial). Edges can be selected and deleted with Backspace. Status indicators update in real time as connections are added/removed.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify complete visual mapping flow</name>
  <files>
    src/app/mapper/page.tsx
  </files>
  <action>
    Human verification of the complete Phase 3 visual mapping interface. All code was automated in Tasks 1 and 2. This checkpoint confirms the visual and interactive elements work correctly end-to-end.

    What was built:
    - /mapper page with source and target upload panels
    - Field tree rendering with expand/collapse
    - Drag-to-connect mapping between source and target fields
    - Mapping status indicators (green/gray/amber dots)
    - Connection deletion via Backspace
    - Connection validation (prevents invalid mappings)
  </action>
  <verify>
    1. Run `npm run dev` and visit http://localhost:3000/mapper
    2. Upload a JSON schema file to the Source panel (left) -- verify field tree appears with expandable nodes
    3. Upload an XSD or JSON file to the Target panel (right) -- verify field tree appears on the right
    4. Click chevrons to expand/collapse nested fields in both trees
    5. Drag from a source field handle (right side dot) to a target field handle (left side dot) -- verify a blue connection line is created
    6. Check that both connected fields now show green status dots
    7. Check that a parent with some children mapped shows amber dot
    8. Try dragging from source to source -- verify connection is rejected
    9. Click on an existing connection line to select it (should highlight)
    10. Press Backspace -- verify the connection is deleted and fields revert to gray dots
    11. Verify the React Flow canvas can be panned (drag background) and zoomed (scroll wheel)
    12. Verify scrolling inside a long field tree does NOT pan the canvas
  </verify>
  <done>
    Human confirms all 5 Phase 3 success criteria met: source/target panels visible, connections drawable, expand/collapse working, mapping status visible, deletion working. Type "approved" or describe any issues found.
  </done>
</task>

</tasks>

<verification>
Phase 3 Success Criteria from ROADMAP:
1. [SC-1] User sees source fields on left panel and target fields on right panel -- verified by upload + tree rendering
2. [SC-2] User can draw a connector from source to target (1:1 mapping) -- verified by drag-to-connect
3. [SC-3] User can expand and collapse nested field structures -- verified by chevron toggle
4. [SC-4] User can see mapping status (mapped/unmapped/partially mapped) -- verified by colored dots
5. [SC-5] User can delete individual mapping connections -- verified by Backspace deletion
</verification>

<success_criteria>
- All 5 Phase 3 success criteria verifiable by human testing
- Connection validation prevents all invalid mapping types
- Mapping status updates in real time as edges are added/removed
- No console errors during normal interaction flow
- Build passes in production mode
- Human verification confirms the visual mapping loop works end-to-end
</success_criteria>

<output>
After completion, create `.planning/phases/03-visual-mapping-interface/03-03-SUMMARY.md`
</output>
