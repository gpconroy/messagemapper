---
phase: 07-platform-features
plan: 04
type: execute
wave: 4
depends_on: ["07-03"]
files_modified:
  - src/app/(protected)/workspace/[workspaceId]/mapper/page.tsx
  - src/app/(protected)/workspace/[workspaceId]/mapper/actions.ts
  - src/app/(protected)/workspace/[workspaceId]/mapper/[mappingId]/page.tsx
  - src/app/api/lookup-tables/route.ts
  - src/app/api/transformations/route.ts
  - src/app/api/transformations/preview/route.ts
  - src/app/api/parse-schema/route.ts
  - src/app/api/parse-sample-data/route.ts
autonomous: false

must_haves:
  truths:
    - "User can save mapping configurations and load them later"
    - "Existing API routes use real session tenantId instead of DEV_TENANT_ID"
    - "Mapper is accessible within workspace context"
    - "Saved mapping can be reopened and shows previous connections"
  artifacts:
    - path: "src/app/(protected)/workspace/[workspaceId]/mapper/actions.ts"
      provides: "Server Actions for save/load mapping configurations"
      exports: ["saveMappingConfig", "loadMappingConfig"]
    - path: "src/app/(protected)/workspace/[workspaceId]/mapper/page.tsx"
      provides: "Workspace-scoped mapper page"
      min_lines: 30
    - path: "src/app/api/lookup-tables/route.ts"
      provides: "Lookup tables API with session-based tenantId"
      contains: "auth()"
  key_links:
    - from: "src/app/(protected)/workspace/[workspaceId]/mapper/actions.ts"
      to: "src/lib/rls.ts"
      via: "tenantQuery for mapping persistence"
      pattern: "tenantQuery"
    - from: "src/app/(protected)/workspace/[workspaceId]/mapper/actions.ts"
      to: "src/auth.ts"
      via: "auth() for session in Server Actions"
      pattern: "auth\\(\\)"
    - from: "src/app/api/lookup-tables/route.ts"
      to: "src/auth.ts"
      via: "auth() replacing DEV_TENANT_ID"
      pattern: "auth\\(\\)"
---

<objective>
Connect the mapper to workspace persistence (save/load mapping configurations) and replace all hardcoded DEV_TENANT_ID with real session-based authentication in API routes.

Purpose: This plan delivers PLAT-07 (save/load mappings) and completes the auth integration by replacing the Phase 5 DEV_TENANT_ID workaround with real session authentication in all API routes. It also includes a human verification checkpoint to validate the entire Phase 7 auth flow end-to-end.

Output: Workspace-scoped mapper with save/load capability, all API routes using session auth, human-verified auth flow.
</objective>

<execution_context>
@C:/Users/gary_/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/gary_/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-platform-features/07-RESEARCH.md
@.planning/phases/07-platform-features/07-01-SUMMARY.md
@.planning/phases/07-platform-features/07-02-SUMMARY.md
@.planning/phases/07-platform-features/07-03-SUMMARY.md
@src/auth.ts
@src/lib/rls.ts
@src/app/mapper/page.tsx
@src/app/api/lookup-tables/route.ts
@src/app/api/transformations/route.ts
@src/app/api/parse-schema/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create workspace-scoped mapper with save/load and update API routes</name>
  <files>
    src/app/(protected)/workspace/[workspaceId]/mapper/page.tsx
    src/app/(protected)/workspace/[workspaceId]/mapper/actions.ts
    src/app/(protected)/workspace/[workspaceId]/mapper/[mappingId]/page.tsx
    src/app/api/lookup-tables/route.ts
    src/app/api/lookup-tables/[id]/entries/route.ts
    src/app/api/transformations/route.ts
    src/app/api/transformations/preview/route.ts
    src/app/api/parse-schema/route.ts
    src/app/api/parse-sample-data/route.ts
  </files>
  <action>
1. Create `src/app/(protected)/workspace/[workspaceId]/mapper/actions.ts`:
   - "use server" directive
   - Import auth from "@/auth", tenantQuery from "@/lib/rls", z from "zod", revalidatePath from "next/cache"

   a) Export async function saveMappingConfig(data: { workspaceId: string, mappingId?: string, name: string, description?: string, sourceSchemaId: string, targetSchemaId: string, mappingData: any }):
      - Get session, verify auth and canEdit
      - Validate inputs with zod
      - If mappingId provided (updating existing):
        - Use tenantQuery to update MappingConfig: set name, description, mappingData, updatedAt
        - Return { success: true, mappingId }
      - If no mappingId (creating new):
        - Use tenantQuery to create MappingConfig with all fields, createdById=session.user.id, status="draft"
        - revalidatePath for workspace page
        - Return { success: true, mappingId: newConfig.id }

   b) Export async function loadMappingConfig(mappingId: string):
      - Get session, verify auth
      - Use tenantQuery to findUnique with include: { sourceSchema: true, targetSchema: true, transformationRules: { orderBy: { order: "asc" } } }
      - If not found, return { error: "Mapping not found" }
      - Return { success: true, mapping }

   c) Export async function saveSchemaToDB(data: { name: string, formatType: string, schemaData: any, tenantId?: string }):
      - Get session, verify auth
      - Use tenantQuery to create FormatSchema with tenantId=session.user.tenantId
      - Return the created schema

2. Create `src/app/(protected)/workspace/[workspaceId]/mapper/page.tsx`:
   - This is a NEW mapper page scoped to a workspace
   - Server Component wrapper that checks auth and loads workspace context
   - Get session, verify auth
   - Load workspace via tenantQuery to confirm access
   - Render a client component that embeds the existing mapper functionality
   - Pass workspaceId and canEdit(session.user.role) as props
   - The client component should:
     - Import all existing mapper components (ReactFlowProvider, SchemaUploadPanel, MappingCanvas, MappingToolbar, ValidationPanel, PreviewPanel, useMappingState, useMappingValidation, useMappingStore)
     - Add a "Save Mapping" button in the toolbar area (only if canEdit)
     - Add a "Save" dialog/form: name, optional description
     - On save: call saveMappingConfig server action with current mapping data (connections from useMappingStore, plus schema IDs)
     - For schema persistence: when schemas are uploaded via SchemaUploadPanel, save them to DB (call saveSchemaToDB) and store the returned schema IDs for use in save
     - Show save status: "Saved" with timestamp, or "Unsaved changes"
   - NOTE: The existing /mapper page (src/app/mapper/page.tsx) should remain functional for now. The new workspace-scoped mapper is the authenticated version.

3. Create `src/app/(protected)/workspace/[workspaceId]/mapper/[mappingId]/page.tsx`:
   - Server Component
   - Get session, verify auth
   - Load the mapping config via loadMappingConfig action
   - If not found or wrong workspace, notFound()
   - Pass the loaded mapping data to the client mapper component
   - The client component initializes with the loaded mapping data (pre-populate schemas and connections)
   - canEdit prop controls whether save button is shown

4. Update ALL existing API routes to replace DEV_TENANT_ID with session-based auth:

   a) `src/app/api/lookup-tables/route.ts`:
      - Remove the DEV_TENANT_ID constant
      - Import auth from "@/auth"
      - At the start of GET and POST handlers: const session = await auth()
      - If !session?.user?.tenantId, return NextResponse.json({ error: "Unauthorized" }, { status: 401 })
      - Replace all DEV_TENANT_ID usages with session.user.tenantId

   b) `src/app/api/lookup-tables/[id]/entries/route.ts`:
      - Same pattern: import auth, check session, use session.user.tenantId
      - Remove any DEV_TENANT_ID references

   c) `src/app/api/transformations/route.ts`:
      - Import auth, check session at start of each handler
      - Use session.user.tenantId for tenantQuery calls

   d) `src/app/api/transformations/preview/route.ts`:
      - Import auth, check session
      - Use session.user.tenantId

   e) `src/app/api/parse-schema/route.ts`:
      - This route currently doesn't use tenantId (it just parses uploaded files)
      - Add auth check: if session exists, proceed; if not, return 401
      - This protects the parsing endpoint from unauthenticated access

   f) `src/app/api/parse-sample-data/route.ts`:
      - Same as parse-schema: add auth check

IMPORTANT NOTES:
- The save flow needs to persist schemas to the DB when uploaded. The existing SchemaUploadPanel calls /api/parse-schema which returns parsed FieldNode trees but doesn't save to DB. The save action will need the schemaData from the uploaded schemas to persist them as FormatSchema records.
- For loading a saved mapping: the page needs to reconstruct the React Flow state (nodes, edges) from the stored mappingData JSON. This may require extending the useMappingStore to accept initial state.
- The middleware from Plan 01 already protects all routes under (protected). API routes under /api/ need their own auth checks since middleware config may exclude /api/auth/* paths.
- When updating API routes, keep existing logic intact -- only replace the DEV_TENANT_ID pattern with session-based auth.
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - `npm run build` completes
    - No references to DEV_TENANT_ID remain in src/ directory
    - All API routes import auth from "@/auth" and check session
    - Workspace mapper page exists at /workspace/[id]/mapper
    - Save/load actions exist and use tenantQuery
  </verify>
  <done>Workspace-scoped mapper supports save/load. All API routes use session-based auth instead of DEV_TENANT_ID. Mapping configurations persist to database and can be reloaded.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Human verification of complete auth and workspace flow</name>
  <files>none (verification only)</files>
  <action>
    Human verifies the complete Phase 7 authentication, RBAC, and workspace management system:
    1. User signup with organization creation
    2. User login/logout with session persistence
    3. Admin role management (assign admin/editor/viewer)
    4. Workspace CRUD within organization
    5. Mapping config management within workspaces
    6. Save/load mapping configurations
    7. Role-based access control (editor can edit, viewer is read-only)
    8. All API routes using real session auth

    Start the dev server: `npm run dev`

    **Test 1: Signup Flow**
    1. Navigate to http://localhost:3000/signup
    2. Fill in name, email, password (8+ chars), organization name
    3. Submit -- should redirect to /dashboard
    4. Verify: Dashboard loads with welcome message and empty workspace list

    **Test 2: Logout and Login**
    1. Click "Sign Out" in the header
    2. Should redirect to /login
    3. Log back in with the credentials from Test 1
    4. Should redirect to /dashboard
    5. Refresh the browser -- session should persist (still on /dashboard, not redirected to /login)

    **Test 3: Workspace Creation**
    1. On /dashboard, create a new workspace (enter name)
    2. Workspace should appear in the grid
    3. Click on the workspace to open /workspace/[id]
    4. Verify: workspace detail page loads with empty mapping list

    **Test 4: Mapper Save/Load**
    1. From workspace page, open the mapper
    2. Upload source and target schemas
    3. Create some connections
    4. Save the mapping (enter name)
    5. Navigate back to workspace page
    6. Verify: saved mapping appears in the list
    7. Open the saved mapping -- connections should be restored

    **Test 5: Role-Based Access**
    1. From /admin/members, invite a new user with "viewer" role
    2. Log out and log in as the viewer
    3. Verify: no "New Workspace" button, no edit/delete controls on mappings
    4. Verify: viewer can still view workspace contents and open mapper in read-only mode

    **Test 6: Route Protection**
    1. Log out
    2. Try to access http://localhost:3000/dashboard directly
    3. Should redirect to /login
    4. Try to access /admin/members -- should redirect to /login

    Report any issues found. Type "approved" if all tests pass, or describe specific failures.
  </action>
  <verify>Human tester completes all 6 test scenarios and reports results.</verify>
  <done>All Phase 7 features verified by human tester: signup, login, logout, session persistence, workspace CRUD, mapping save/load, role-based access control, and route protection.</done>
</task>

</tasks>

<verification>
- grep -r "DEV_TENANT_ID" src/ returns no results
- All 8 success criteria from phase goal are testable
- Save/load creates and retrieves MappingConfig records from database
- Role-based controls hide edit functionality for viewers
</verification>

<success_criteria>
Mapping save/load works within workspace context (PLAT-07). All API routes use real session auth. Human tester confirms: signup, login, logout, workspace CRUD, mapping save/load, role-based access, and route protection all function correctly.
</success_criteria>

<output>
After completion, create `.planning/phases/07-platform-features/07-04-SUMMARY.md`
</output>
