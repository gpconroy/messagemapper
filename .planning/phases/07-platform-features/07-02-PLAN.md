---
phase: 07-platform-features
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - src/app/(auth)/login/page.tsx
  - src/app/(auth)/login/actions.ts
  - src/app/(auth)/signup/page.tsx
  - src/app/(auth)/signup/actions.ts
  - src/app/(auth)/layout.tsx
  - src/components/LogoutButton.tsx
  - src/app/layout.tsx
autonomous: true

must_haves:
  truths:
    - "User can create an account with email, password, name, and organization name"
    - "User can log in with email and password"
    - "User can log out from any page"
    - "Session persists across browser refreshes"
    - "Invalid credentials show error message on login page"
    - "Duplicate email shows error message on signup page"
  artifacts:
    - path: "src/app/(auth)/signup/page.tsx"
      provides: "Signup form UI"
      min_lines: 30
    - path: "src/app/(auth)/signup/actions.ts"
      provides: "Server Action for user+tenant creation"
      exports: ["signup"]
    - path: "src/app/(auth)/login/page.tsx"
      provides: "Login form UI"
      min_lines: 30
    - path: "src/app/(auth)/login/actions.ts"
      provides: "Server Action for authentication"
      exports: ["login"]
    - path: "src/components/LogoutButton.tsx"
      provides: "Logout button component"
      exports: ["LogoutButton"]
  key_links:
    - from: "src/app/(auth)/signup/actions.ts"
      to: "src/lib/auth/passwords.ts"
      via: "hashPassword for new user"
      pattern: "hashPassword"
    - from: "src/app/(auth)/signup/actions.ts"
      to: "prisma.$transaction"
      via: "atomic tenant+user creation"
      pattern: "\\$transaction"
    - from: "src/app/(auth)/login/actions.ts"
      to: "src/auth.ts"
      via: "signIn for credentials auth"
      pattern: "signIn"
    - from: "src/components/LogoutButton.tsx"
      to: "next-auth/react"
      via: "signOut for session invalidation"
      pattern: "signOut"
---

<objective>
Build signup, login, and logout flows with Server Actions and clean auth UI pages.

Purpose: Users need to create accounts, authenticate, and log out. This plan implements the full authentication user flow (PLAT-01, PLAT-02, PLAT-03) building on the Auth.js infrastructure from Plan 01.

Output: Working signup page (creates user+tenant), login page (authenticates and creates session), logout button (clears session), auth layout for public pages.
</objective>

<execution_context>
@C:/Users/gary_/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/gary_/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-platform-features/07-RESEARCH.md
@.planning/phases/07-platform-features/07-01-SUMMARY.md
@src/auth.ts
@src/lib/auth/passwords.ts
@src/lib/prisma.ts
@prisma/schema.prisma
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create signup and login Server Actions</name>
  <files>
    src/app/(auth)/signup/actions.ts
    src/app/(auth)/login/actions.ts
  </files>
  <action>
1. Create `src/app/(auth)/signup/actions.ts`:
   - Add "use server" directive at top
   - Import prisma from "@/lib/prisma", hashPassword from "@/lib/auth/passwords", signIn from "@/auth", z from "zod"
   - Define signupSchema with zod:
     - email: z.string().email("Invalid email address")
     - password: z.string().min(8, "Password must be at least 8 characters")
     - name: z.string().min(1, "Name is required")
     - organizationName: z.string().min(1, "Organization name is required")
   - Export async function signup(prevState: any, formData: FormData):
     - Parse form data with signupSchema (wrap in try/catch, return { error: zodError.errors[0].message } on ZodError)
     - Check for existing user: prisma.user.findUnique({ where: { email } })
     - If exists: return { error: "Email already registered" }
     - Hash password with hashPassword()
     - Create tenant and user atomically in prisma.$transaction:
       - Create Tenant with name=organizationName, slug=organizationName.toLowerCase().replace(/\s+/g, "-").replace(/[^a-z0-9-]/g, "")
       - Create User with email, name, passwordHash, role="admin" (first user is always admin), tenantId=tenant.id
     - After transaction succeeds, call signIn("credentials", { email, password, redirectTo: "/dashboard" })
     - Return { success: true } (though signIn will redirect before this returns)
     - Wrap entire function in try/catch, return { error: "An error occurred during signup" } on unexpected errors

2. Create `src/app/(auth)/login/actions.ts`:
   - Add "use server" directive
   - Import signIn from "@/auth"
   - Import z from "zod"
   - Import AuthError from "next-auth"
   - Define loginSchema: email z.string().email(), password z.string().min(1, "Password is required")
   - Export async function login(prevState: any, formData: FormData):
     - Parse with loginSchema (return error on ZodError)
     - Call signIn("credentials", { email, password, redirectTo: formData.get("callbackUrl") as string || "/dashboard" })
     - Catch errors: if error is AuthError (specifically CredentialsSignin), return { error: "Invalid email or password" }. For NEXT_REDIRECT errors, re-throw them (signIn uses redirect internally). For other errors, return { error: "An error occurred" }
     - Return { success: true }

IMPORTANT NOTES:
- Use prevState parameter signature for compatibility with useActionState (React 19 pattern)
- signIn() from @/auth throws a NEXT_REDIRECT error on success -- this is expected behavior, do NOT catch it. The pattern is: try { await signIn(...) } catch(error) { if (error instanceof AuthError) { handle } throw error }
- Do NOT import signIn from "next-auth/react" in server actions -- use the server-side signIn from "@/auth"
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - Both files exist with "use server" directive
    - signup action creates tenant+user in transaction
    - login action calls signIn with credentials
  </verify>
  <done>Signup Server Action creates user+tenant atomically with Argon2id hashed password. Login Server Action authenticates via Auth.js credentials provider. Both return structured error objects for form display.</done>
</task>

<task type="auto">
  <name>Task 2: Create auth pages, logout button, and auth layout</name>
  <files>
    src/app/(auth)/layout.tsx
    src/app/(auth)/login/page.tsx
    src/app/(auth)/signup/page.tsx
    src/components/LogoutButton.tsx
    src/app/layout.tsx
  </files>
  <action>
1. Create `src/app/(auth)/layout.tsx`:
   - Simple centered layout for auth pages: flex min-h-screen items-center justify-center bg-gray-50
   - Render children in a card container: max-w-md w-full bg-white rounded-lg shadow-md p-8
   - Include MessageMapper branding at top of card (green text, consistent with existing header)

2. Create `src/app/(auth)/signup/page.tsx`:
   - "use client" directive (needed for useActionState)
   - Import useActionState from "react" (React 19 pattern)
   - Import signup action from "./actions"
   - Import Link from "next/link"
   - Form with fields: name (text), email (email), password (password), organizationName (text labeled "Organization Name")
   - Use useActionState(signup, { error: null }) for form state
   - Display error message if state.error exists (red text above submit button)
   - Submit button: "Create Account" with green-600 bg, full width
   - Link at bottom: "Already have an account? Log in" linking to /login
   - All inputs have: name attribute matching action field names, required attribute, appropriate placeholder text
   - Tailwind styling: consistent with existing app aesthetic (gray borders, rounded inputs, gap-4 spacing)

3. Create `src/app/(auth)/login/page.tsx`:
   - "use client" directive
   - Import useActionState from "react"
   - Import login action from "./actions"
   - Import Link from "next/link"
   - Import useSearchParams from "next/navigation" to read callbackUrl
   - Form with fields: email (email), password (password)
   - Hidden input for callbackUrl from searchParams
   - Use useActionState(login, { error: null })
   - Display error message if state.error exists
   - Submit button: "Sign In" with green-600 bg, full width
   - Link at bottom: "Don't have an account? Sign up" linking to /signup
   - Tailwind styling consistent with signup page

4. Create `src/components/LogoutButton.tsx`:
   - "use client" directive
   - Import signOut from "next-auth/react" (client-side signOut)
   - Export function LogoutButton():
     - Button that calls signOut({ callbackUrl: "/login" }) on click
     - Styling: text-sm text-white/80 hover:text-white (to match green header)
     - Text: "Sign Out"

5. Update `src/app/layout.tsx`:
   - Wrap children with SessionProvider from "next-auth/react"
   - Import SessionProvider
   - This is required for useSession() and client-side signOut() to work
   - Keep existing fonts and metadata
   - SessionProvider wraps {children} inside the body tag

IMPORTANT NOTES:
- useActionState is the React 19 pattern (replaces useFormState from react-dom). Signature: const [state, formAction] = useActionState(action, initialState)
- The form action attribute should be set to formAction from useActionState
- Do NOT use "use server" in page.tsx files -- only in action files
- The (auth) directory is a route group (parentheses) -- it does NOT create a URL segment. /login and /signup are the actual URLs.
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - `npm run build` completes
    - All page files exist in correct directories
    - Login page at /login renders form with email+password
    - Signup page at /signup renders form with name+email+password+org
    - LogoutButton component exists and imports signOut from next-auth/react
    - Root layout wraps children in SessionProvider
  </verify>
  <done>Auth UI complete: signup page creates account with organization, login page authenticates with email/password, logout button clears session. SessionProvider wraps app for client-side session access. All pages use consistent green-themed Tailwind styling.</done>
</task>

</tasks>

<verification>
- Signup form submits and creates user+tenant in database
- Login form authenticates and redirects to /dashboard
- Logout button clears session and redirects to /login
- Invalid credentials show error on login page
- Duplicate email shows error on signup page
- Session persists after browser refresh (JWT in HttpOnly cookie)
</verification>

<success_criteria>
Full authentication flow works: signup creates user+tenant, login authenticates and creates JWT session, logout clears session. All three PLAT-01/02/03 requirements are met.
</success_criteria>

<output>
After completion, create `.planning/phases/07-platform-features/07-02-SUMMARY.md`
</output>
