---
phase: 05-transformation-system
plan: 06
type: execute
wave: 4
depends_on: ["05-05"]
files_modified:
  - src/app/mapper/components/MappingCanvas.tsx
  - src/app/mapper/hooks/useMappingState.ts
  - src/app/mapper/components/LookupTableManager.tsx
  - src/app/mapper/components/CustomJSEditor.tsx
  - src/app/mapper/components/config-forms/LookupForm.tsx
  - src/app/mapper/components/config-forms/CustomJSForm.tsx
  - src/app/mapper/components/TransformationDialog.tsx
  - src/app/mapper/page.tsx
autonomous: false

must_haves:
  truths:
    - "User can click a mapping edge to open the transformation dialog"
    - "User can see transformation badges on edges that have transformations applied"
    - "User can create and manage lookup tables with from/to value entries"
    - "User can write custom JavaScript transformation code in a textarea editor"
    - "All 7 transformation types are configurable from the UI"
  artifacts:
    - path: "src/app/mapper/components/MappingCanvas.tsx"
      provides: "Updated canvas with edge click handler and custom edge rendering for transformation badges"
      min_lines: 60
    - path: "src/app/mapper/components/LookupTableManager.tsx"
      provides: "CRUD UI for lookup tables and entries"
      min_lines: 80
    - path: "src/app/mapper/components/CustomJSEditor.tsx"
      provides: "JavaScript code editor with syntax highlighting textarea"
      min_lines: 40
    - path: "src/app/mapper/components/config-forms/LookupForm.tsx"
      provides: "Lookup table selector form for transformation dialog"
      min_lines: 30
    - path: "src/app/mapper/components/config-forms/CustomJSForm.tsx"
      provides: "Custom JS code input form for transformation dialog"
      min_lines: 30
  key_links:
    - from: "src/app/mapper/components/MappingCanvas.tsx"
      to: "src/app/mapper/store/useMappingStore.ts"
      via: "Edge click handler sets selectedConnectionId"
      pattern: "setSelectedConnectionId|onEdgeClick"
    - from: "src/app/mapper/components/MappingCanvas.tsx"
      to: "src/app/mapper/components/TransformationBadge.tsx"
      via: "Custom edge label rendering for transformed edges"
      pattern: "TransformationBadge|edgeTypes|label"
    - from: "src/app/mapper/components/LookupTableManager.tsx"
      to: "/api/lookup-tables"
      via: "Fetch calls for CRUD operations"
      pattern: "fetch.*lookup-tables"
    - from: "src/app/mapper/components/config-forms/CustomJSForm.tsx"
      to: "/api/transformations/preview"
      via: "Test execution button calls preview API"
      pattern: "fetch.*transformations/preview"
---

<objective>
Complete the transformation system by integrating all components: wire edge click to dialog, add lookup table management UI, add custom JS editor, render transformation badges on edges, and verify the complete feature set with human testing.

Purpose: This is the integration plan that connects the backend engine (Plans 01-04) with the UI (Plan 05) and adds the remaining UI for XFRM-06 (lookup tables) and XFRM-07 (custom JavaScript). After this plan, all 7 transformation requirements are fully functional end-to-end.

Output: Complete, interactive transformation system where users can configure any of the 7 transformation types on mapping connections.
</objective>

<execution_context>
@C:/Users/gary_/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/gary_/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-transformation-system/05-05-SUMMARY.md
@src/app/mapper/components/MappingCanvas.tsx
@src/app/mapper/hooks/useMappingState.ts
@src/app/mapper/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire edge interactions, lookup/JS forms, and canvas integration</name>
  <files>
    src/app/mapper/components/MappingCanvas.tsx
    src/app/mapper/hooks/useMappingState.ts
    src/app/mapper/components/config-forms/LookupForm.tsx
    src/app/mapper/components/config-forms/CustomJSForm.tsx
    src/app/mapper/components/LookupTableManager.tsx
    src/app/mapper/components/CustomJSEditor.tsx
    src/app/mapper/components/TransformationDialog.tsx
    src/app/mapper/page.tsx
  </files>
  <action>
    **MappingCanvas.tsx updates:**
    - Add onEdgeClick handler: when user clicks an edge, call store.setSelectedConnectionId(edge.id) to open the transformation dialog
    - Update edge rendering: for edges whose connection has a transformation, add a label using React Flow's edge label feature. The label should render the TransformationBadge component showing the transformation type abbreviation. Use the `label` and `labelStyle` properties on edges, or use a custom edge type.
    - Import TransformationDialog and render it inside the canvas container (outside ReactFlow but inside the MappingStatusContext.Provider). It will show/hide based on selectedConnectionId state.
    - Pass the edge click handler as onEdgeClick prop to ReactFlow component.

    **useMappingState.ts updates:**
    - Update the edges useMemo to include transformation data from store connections. For edges with transformations, set the edge label to the transformation type abbreviation (use a small inline React element or string). Set edge style to a distinct color (e.g., stroke: '#7c3aed' purple instead of blue) to visually differentiate transformed edges.

    **LookupForm.tsx:**
    'use client' config form for the transformation dialog.
    - Fetch available lookup tables from GET /api/lookup-tables on mount
    - Render dropdown of available tables
    - Text input for default value (optional, used when no match found)
    - "Manage Tables" button that opens LookupTableManager

    **CustomJSForm.tsx:**
    'use client' config form for the transformation dialog.
    - Textarea with monospace font for JavaScript code input (min-height: 150px)
    - Helper text explaining: "Write JavaScript that transforms the `input` variable and returns the result."
    - Code template button that inserts: "// input contains the source field value\nreturn input;"
    - Timeout input (number, default 5000ms, max 30000ms)
    - "Test" button that calls POST /api/transformations/preview with the custom_js rule and shows result/error below
    - Show test result in a green (success) or red (error) box below the textarea

    **TransformationDialog.tsx update:**
    - Add 'lookup' and 'custom_js' to the type selector dropdown (labels: "Lookup Table", "Custom JavaScript")
    - Import and render LookupForm when type is 'lookup'
    - Import and render CustomJSForm when type is 'custom_js'
    - Now all 8 types available (but 'custom_js' shows as "Custom JavaScript" and 'lookup' as "Lookup Table")

    **LookupTableManager.tsx:**
    'use client' full-page or modal component for CRUD management of lookup tables.
    - Left panel: list of lookup tables (fetched from GET /api/lookup-tables), with "New Table" button
    - Right panel: entries for selected table (fetched from GET /api/lookup-tables/[id]/entries)
    - Add entry form: two text inputs (From Value, To Value) + Add button
    - Each entry row: From -> To display, with Edit and Delete buttons
    - Edit inline: clicking Edit makes the row editable
    - Delete: confirm then DELETE
    - Create table form: name input + description textarea + Create button
    - Tailwind styling: consistent with existing app, border cards, gap-4 spacing
    - Accessible from LookupForm's "Manage Tables" button and potentially from a toolbar link

    **CustomJSEditor.tsx:**
    Reusable textarea editor component (used by CustomJSForm):
    - Monospace font (font-mono), dark background (bg-gray-900 text-green-400) for code feel
    - Line numbers in left gutter (optional - skip if complex, just use plain textarea)
    - Tab key inserts 2 spaces instead of changing focus
    - Accepts value, onChange, placeholder props
    - Min-height configurable

    **page.tsx updates:**
    - If LookupTableManager is rendered as a separate view/modal, add a toggle button in the mapper page toolbar area (e.g., next to undo/redo buttons, add a "Lookup Tables" button)
  </action>
  <verify>
    `npm run build` succeeds.
    Dev server running:
    1. Navigate to /mapper
    2. Upload source and target schemas
    3. Create a mapping connection (drag source field to target field)
    4. Click on the connection edge - transformation dialog opens
    5. Select "Constant Value" type, enter a value, click Apply
    6. Edge now shows visual badge/indicator and different color
    7. Click edge again - dialog shows existing transformation
    8. Click "Remove" - transformation removed, edge returns to default style
  </verify>
  <done>Edge click opens transformation dialog. All 7+1 transformation types configurable. Transformed edges visually distinct. Lookup table management UI functional. Custom JS editor with test capability. Complete integration.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Human verification of complete transformation system</name>
  <files>none</files>
  <action>
    Human verifies that the complete Phase 5 transformation system works end-to-end with all 7 transformation types:
    1. Format conversion (date, number, currency) - XFRM-01
    2. Field concatenation with separator - XFRM-02
    3. Field splitting by delimiter/regex - XFRM-03
    4. Constant value assignment - XFRM-04
    5. Conditional mapping rules - XFRM-05
    6. Lookup table code translation - XFRM-06
    7. Custom JavaScript functions - XFRM-07

    Start dev server: `npm run dev`
    Navigate to http://localhost:3000/mapper

    **Test 1: Basic transformation configuration**
    1. Upload a source schema (use sample-source-order.xml or a JSON file)
    2. Upload a target schema (use sample-target-transfer.json or another file)
    3. Draw a mapping connection from a source field to a target field
    4. Click on the connection edge
    5. Verify: Transformation dialog opens showing source and target field names

    **Test 2: Constant value (XFRM-04)**
    1. In the dialog, select "Constant Value" type
    2. Enter "ACTIVE" as the value
    3. Click Apply
    4. Verify: Edge shows a visual badge/indicator, edge color changes

    **Test 3: Date format (XFRM-01)**
    1. Click on another mapping edge (or create new)
    2. Select "Date Format" type
    3. Enter source format "yyyyMMdd" and target format "MM/dd/yyyy"
    4. Click Apply
    5. Verify: Badge shows "Dt" or date icon

    **Test 4: Conditional logic (XFRM-05)**
    1. Configure a conditional: operator "equals", value "USD", then "US Dollar", else "Other"
    2. Click Apply
    3. Verify: Badge shows conditional indicator

    **Test 5: Lookup table management (XFRM-06)**
    1. Click a mapping edge, select "Lookup Table" type
    2. Click "Manage Tables" to open lookup table manager
    3. Create a new table named "currency_codes"
    4. Add entries: USD -> US Dollar, EUR -> Euro, GBP -> British Pound
    5. Select the table in the lookup form dropdown
    6. Verify: Table and entries are persisted (refresh page and check)

    **Test 6: Custom JavaScript (XFRM-07)**
    1. Click a mapping edge, select "Custom JavaScript"
    2. Enter code: `return input.toUpperCase();`
    3. Click "Test" button with a sample input
    4. Verify: Test result shows the uppercased value
    5. Click Apply

    **Test 7: Undo/redo with transformations**
    1. Apply a transformation to an edge
    2. Press Ctrl+Z to undo
    3. Verify: Transformation is removed
    4. Press Ctrl+Y or Ctrl+Shift+Z to redo
    5. Verify: Transformation is restored
  </action>
  <verify>Human confirms all 7 test scenarios pass by typing "approved"</verify>
  <done>All 7 transformation types verified working by human tester. Phase 5 success criteria met.</done>
</task>

</tasks>

<verification>
- All 7 transformation types configurable through UI (XFRM-01 through XFRM-07)
- Edge click opens dialog with current transformation config
- Transformed edges are visually distinct from plain mappings
- Lookup tables persist via API
- Custom JS test execution works via preview API
- Undo/redo includes transformation changes
- No console errors during interaction
</verification>

<success_criteria>
Human verifier confirms: all 7 transformation types configurable, visual indicators on transformed edges, lookup table CRUD works, custom JS test execution works, undo/redo includes transformations. Phase 5 success criteria satisfied.
</success_criteria>

<output>
After completion, create `.planning/phases/05-transformation-system/05-06-SUMMARY.md`
</output>
