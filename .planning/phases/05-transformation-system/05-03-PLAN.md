---
phase: 05-transformation-system
plan: 03
type: tdd
wave: 1
depends_on: []
files_modified:
  - src/transformations/custom/sandbox.ts
  - src/transformations/__tests__/sandbox.test.ts
autonomous: true

must_haves:
  truths:
    - "Custom JavaScript code executes in an isolated V8 sandbox separate from the Node.js process"
    - "Sandbox enforces a configurable timeout to prevent infinite loops"
    - "Sandbox enforces a configurable memory limit to prevent memory exhaustion"
    - "Sandbox isolate is always disposed after execution to prevent memory leaks"
    - "Custom code receives input data and returns a transformed result"
  artifacts:
    - path: "src/transformations/custom/sandbox.ts"
      provides: "Secure JavaScript sandbox execution using isolated-vm"
      exports: ["executeCustomJS", "SandboxOptions"]
    - path: "src/transformations/__tests__/sandbox.test.ts"
      provides: "Test coverage for sandbox execution, timeouts, memory limits, and cleanup"
      min_lines: 60
  key_links:
    - from: "src/transformations/custom/sandbox.ts"
      to: "isolated-vm"
      via: "npm dependency for V8 Isolate creation"
      pattern: "import.*isolated-vm"
---

<objective>
Implement secure custom JavaScript execution sandbox using isolated-vm with strict resource limits, full TDD coverage for security-critical code.

Purpose: Enables XFRM-07 (custom JavaScript transformation functions) with proper security isolation. This is the most security-critical component in the transformation system - custom user code must never escape the sandbox, exhaust memory, or run indefinitely.

Output: A tested sandbox module that safely executes arbitrary JavaScript with configurable timeout and memory limits.
</objective>

<execution_context>
@C:/Users/gary_/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/gary_/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-transformation-system/05-RESEARCH.md
</context>

<tasks>

<task type="tdd">
  <name>Custom JavaScript Sandbox</name>
  <files>
    src/transformations/custom/sandbox.ts
    src/transformations/__tests__/sandbox.test.ts
  </files>
  <action>
    Install isolated-vm: `npm install isolated-vm`

    **CRITICAL: Do NOT use vm2 - it has multiple sandbox escape CVEs (CVE-2026-22709 and others). Use isolated-vm which uses V8's native Isolate interface.**

    Follow TDD RED-GREEN-REFACTOR cycle.

    **RED phase - Write failing tests first (src/transformations/__tests__/sandbox.test.ts):**

    **SandboxOptions interface:**
    - timeout: number (milliseconds, default 5000)
    - memoryLimit: number (MB, default 128)

    **executeCustomJS(code: string, input: unknown, options?: SandboxOptions): Promise&lt;unknown&gt;**

    Test cases:

    Basic execution:
    - code: 'return input.toUpperCase()', input: 'hello' -> 'HELLO'
    - code: 'return input * 2', input: 21 -> 42
    - code: 'return { name: input.first + " " + input.last }', input: { first: 'John', last: 'Doe' } -> { name: 'John Doe' }

    Timeout enforcement:
    - code: 'while(true) {}', input: null, options: { timeout: 100 } -> throws Error containing 'timed out' or 'timeout'

    Memory limit enforcement:
    - code: 'let a = []; while(true) { a.push(new Array(1000000)) }', input: null, options: { memoryLimit: 8 } -> throws Error containing 'memory'

    Error handling:
    - code: 'throw new Error("bad")', input: null -> throws Error
    - code: 'return undefined_variable', input: null -> throws Error

    Input isolation (sandbox cannot modify caller data):
    - After executing code that modifies input, original input object is unchanged

    No access to Node.js APIs:
    - code: 'return typeof require', input: null -> 'undefined'
    - code: 'return typeof process', input: null -> 'undefined'

    Note: Some of these tests (especially memory limit) may be flaky in CI. Mark memory limit test with a longer timeout. If isolated-vm compilation fails on Windows, check Node.js version compatibility and --no-node-snapshot flag for Node.js 20+.

    **GREEN phase - Implement to pass tests (src/transformations/custom/sandbox.ts):**

    Wraps code in an IIFE: `(function() { ${code} })()`
    Sets `input` as a global variable in the sandbox context using ExternalCopy.copyInto()
    Compiles and runs script with timeout
    Always disposes isolate in finally block
    Returns the result of the script execution

    Use isolated-vm (NOT vm2). Create a new Isolate per execution with the specified memoryLimit. Create a context, set input as a global via ExternalCopy, compile the user code wrapped in an IIFE, run with timeout. Always dispose the isolate in a finally block to prevent memory leaks.

    Handle three categories of errors:
    1. Timeout errors - detect via error message containing 'timeout' or 'Script execution timed out', rethrow as 'Transformation timed out (limit: Xms)'
    2. Memory errors - detect via error message containing 'memory', rethrow as 'Transformation exceeded memory limit (limit: XMB)'
    3. Code errors - rethrow with 'Custom transformation error: [original message]'

    If isolated-vm fails to install (native module compilation issues), document the error and provide a fallback implementation using Function constructor with a note that it is NOT secure and should only be used for local development. The fallback should log a prominent console.warn about the security implication.
  </action>
  <verify>
    `npm install isolated-vm` succeeds (native module compiles).
    `npm test -- --testPathPattern="sandbox"` passes all test cases.
    Timeout test completes within 2x the specified timeout (not hanging).
    No memory leaks reported (isolate.dispose() called in all paths).
  </verify>
  <done>Custom JavaScript executes in isolated V8 sandbox. Timeout stops infinite loops. Memory limit prevents exhaustion. Isolate always cleaned up. No access to Node.js globals (require, process, fs). Tests prove all safety constraints hold.</done>
</task>

</tasks>

<verification>
- `npm install isolated-vm` succeeds (native module compiles)
- `npm test -- --testPathPattern="sandbox"` passes all test cases
- Timeout test completes within 2x the specified timeout (not hanging)
- No memory leaks reported (isolate.dispose() called in all paths)
</verification>

<success_criteria>
Custom JavaScript executes in isolated V8 sandbox. Timeout stops infinite loops. Memory limit prevents exhaustion. Isolate always cleaned up. No access to Node.js globals (require, process, fs). Tests prove all safety constraints hold.
</success_criteria>

<output>
After completion, create `.planning/phases/05-transformation-system/05-03-SUMMARY.md`
</output>
