---
phase: 05-transformation-system
plan: 05
type: execute
wave: 3
depends_on: ["05-04"]
files_modified:
  - src/app/mapper/components/TransformationDialog.tsx
  - src/app/mapper/components/TransformationBadge.tsx
  - src/app/mapper/components/config-forms/DateFormatForm.tsx
  - src/app/mapper/components/config-forms/NumberFormatForm.tsx
  - src/app/mapper/components/config-forms/StringOpForm.tsx
  - src/app/mapper/components/config-forms/ConditionalForm.tsx
  - src/app/mapper/components/config-forms/ConstantForm.tsx
  - src/app/mapper/store/useMappingStore.ts
  - src/types/mapping-types.ts
autonomous: true

must_haves:
  truths:
    - "User can click on a mapping connection to open a transformation configuration dialog"
    - "User can select a transformation type from the available options"
    - "User can configure transformation parameters specific to each type"
    - "User can see which connections have transformations applied via visual indicator"
    - "Transformation configuration is stored in the mapping store alongside connections"
  artifacts:
    - path: "src/app/mapper/components/TransformationDialog.tsx"
      provides: "Modal dialog for configuring transformation on a mapping connection"
      min_lines: 80
    - path: "src/app/mapper/components/TransformationBadge.tsx"
      provides: "Visual badge on edges indicating transformation type"
      min_lines: 20
    - path: "src/app/mapper/components/config-forms/DateFormatForm.tsx"
      provides: "Date format configuration form with from/to format inputs"
      min_lines: 30
    - path: "src/app/mapper/components/config-forms/NumberFormatForm.tsx"
      provides: "Number format configuration form with type/currency/locale inputs"
      min_lines: 30
    - path: "src/app/mapper/components/config-forms/StringOpForm.tsx"
      provides: "Split and concatenate configuration forms"
      min_lines: 40
    - path: "src/app/mapper/components/config-forms/ConditionalForm.tsx"
      provides: "Conditional logic configuration form with operator/value/then/else inputs"
      min_lines: 40
    - path: "src/app/mapper/components/config-forms/ConstantForm.tsx"
      provides: "Constant value configuration form"
      min_lines: 20
  key_links:
    - from: "src/app/mapper/components/TransformationDialog.tsx"
      to: "src/app/mapper/store/useMappingStore.ts"
      via: "Store action to save transformation config on connection"
      pattern: "setConnectionTransform|updateTransformation"
    - from: "src/app/mapper/components/TransformationDialog.tsx"
      to: "src/transformations/types.ts"
      via: "Import TransformationType for type selector"
      pattern: "import.*TransformationType"
    - from: "src/app/mapper/components/TransformationBadge.tsx"
      to: "src/app/mapper/store/useMappingStore.ts"
      via: "Read transformation config from store"
      pattern: "useMappingStore|connections.*transformation"
---

<objective>
Build the transformation configuration UI - dialog for configuring transformations on mapping connections, type-specific configuration forms, and visual indicators showing which connections have transformations.

Purpose: Makes the transformation engine accessible to users. Without UI, users cannot configure transformations on their field mappings. This covers the user-facing part of XFRM-01 through XFRM-05, providing forms for each built-in transformation type.

Output: A clickable transformation dialog on mapping edges, per-type configuration forms, visual badges on transformed edges, and store integration for persisting transform configs.
</objective>

<execution_context>
@C:/Users/gary_/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/gary_/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-transformation-system/05-04-SUMMARY.md
@src/app/mapper/store/useMappingStore.ts
@src/app/mapper/components/MappingCanvas.tsx
@src/types/mapping-types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend mapping store and types for transformation configuration</name>
  <files>
    src/types/mapping-types.ts
    src/app/mapper/store/useMappingStore.ts
  </files>
  <action>
    **src/types/mapping-types.ts:**
    Add ConnectionTransformation interface:
    ```
    interface ConnectionTransformation {
      type: TransformationType (import from transformations/types)
      config: Record&lt;string, unknown&gt;
      label?: string
    }
    ```
    Update MappingEdgeData to include optional transformation field:
    ```
    interface MappingEdgeData extends Record&lt;string, unknown&gt; {
      sourceFieldPath: string
      targetFieldPath: string
      transformation?: ConnectionTransformation
    }
    ```

    **src/app/mapper/store/useMappingStore.ts:**
    Extend the connection type in MappingStoreState to include optional transformation:
    ```
    connections: Array<{
      id: string
      sourceFieldPath: string
      targetFieldPath: string
      transformation?: ConnectionTransformation
    }>
    ```
    Add new store actions:
    - setConnectionTransform(connectionId: string, transformation: ConnectionTransformation): void - sets transformation on an existing connection
    - removeConnectionTransform(connectionId: string): void - removes transformation from a connection
    - getConnectionTransform(connectionId: string): ConnectionTransformation | undefined - retrieves current transformation

    The transformation data must be included in the temporal partialize so undo/redo tracks transformation changes alongside connection changes.

    Also add to store state:
    - selectedConnectionId: string | null - tracks which connection is currently selected for transformation editing
    - setSelectedConnectionId(id: string | null): void
  </action>
  <verify>
    `npm run build` succeeds without TypeScript errors.
    Types correctly extend existing interfaces without breaking MappingCanvas or useMappingState.
  </verify>
  <done>Store supports transformation configuration per connection with undo/redo tracking. Selected connection state enables dialog opening on edge click.</done>
</task>

<task type="auto">
  <name>Task 2: Create transformation dialog with type-specific config forms</name>
  <files>
    src/app/mapper/components/TransformationDialog.tsx
    src/app/mapper/components/TransformationBadge.tsx
    src/app/mapper/components/config-forms/DateFormatForm.tsx
    src/app/mapper/components/config-forms/NumberFormatForm.tsx
    src/app/mapper/components/config-forms/StringOpForm.tsx
    src/app/mapper/components/config-forms/ConditionalForm.tsx
    src/app/mapper/components/config-forms/ConstantForm.tsx
  </files>
  <action>
    **TransformationDialog.tsx:**
    'use client' component that renders a modal overlay when selectedConnectionId is not null.
    - Reads selectedConnectionId from useMappingStore
    - Finds the connection by ID to get current sourceFieldPath, targetFieldPath, and existing transformation
    - Header shows "Configure Transformation: {sourceField} -> {targetField}"
    - Dropdown/select for TransformationType (show human-readable labels: "Date Format", "Number Format", "Split", "Concatenate", "Conditional Logic", "Constant Value"). Exclude 'lookup' and 'custom_js' - those get dedicated UI in Plan 06.
    - Below the type selector, render the appropriate config form component based on selected type
    - "Apply" button saves transformation to store via setConnectionTransform
    - "Remove" button (shown when transformation exists) removes via removeConnectionTransform
    - "Cancel" button closes dialog via setSelectedConnectionId(null)
    - Close on Escape key press
    - Tailwind styling: fixed overlay with dark background, centered white card, max-w-lg

    **TransformationBadge.tsx:**
    Small badge component that renders on edges with transformations.
    - Accepts: type (TransformationType), onClick callback
    - Renders a small colored pill with abbreviated type name (e.g., "Dt" for format_date, "#" for format_number, "Split", "Join", "If", "=")
    - Tailwind: bg-indigo-100 text-indigo-800 text-xs px-1.5 py-0.5 rounded-full cursor-pointer hover:bg-indigo-200

    **Config Forms (all 'use client'):**
    Each form accepts: config (current config or {}), onChange (callback with updated config object).

    DateFormatForm: Two text inputs - "Source Format" (placeholder: "yyyyMMdd", optional - leave blank for auto-detect) and "Target Format" (placeholder: "MM/dd/yyyy", required). Show common format examples as helper text.

    NumberFormatForm: Select for type (number/currency). If currency: text input for currency code (e.g., "USD", "EUR") and locale (e.g., "en-US"). Optional inputs for min/max fraction digits.

    StringOpForm: Radio toggle for mode (split/concatenate). Split mode: text input for delimiter, checkbox for "Use Regex", checkbox for "Trim whitespace". Concatenate mode: text input for separator, checkbox for "Trim whitespace".

    ConditionalForm: Select for operator (equals, notEquals, contains, startsWith, endsWith, greaterThan, lessThan). Text input for comparison value. Text input for "Then value" and "Else value".

    ConstantForm: Single text input for the constant value. Type selector (string/number/boolean/null) that coerces the value appropriately.

    All forms use Tailwind styling consistent with existing app. Labels above inputs, gap-2 spacing, border-gray-300 inputs.
  </action>
  <verify>
    `npm run build` succeeds without TypeScript errors.
    Dev server running, navigate to /mapper, upload two schemas, create a mapping connection, clicking should eventually wire to dialog (full wiring in Plan 06 integration task but component renders without errors).
  </verify>
  <done>TransformationDialog renders as modal with type selector and dynamic config forms. Each built-in type (date, number, split, concat, conditional, constant) has a dedicated config form. Badge component ready for edge rendering. Store integration saves/removes transformations.</done>
</task>

</tasks>

<verification>
- All new components compile without errors
- Store correctly persists transformation config per connection
- Undo/redo includes transformation changes
- Dialog opens/closes correctly
- Each config form renders appropriate inputs for its type
- TransformationBadge displays correct abbreviation for each type
</verification>

<success_criteria>
Transformation dialog renders with type selector and per-type config forms. Store tracks transformations per connection with undo/redo. Badge component ready. All built-in types (XFRM-01 through XFRM-05) have configuration UI.
</success_criteria>

<output>
After completion, create `.planning/phases/05-transformation-system/05-05-SUMMARY.md`
</output>
